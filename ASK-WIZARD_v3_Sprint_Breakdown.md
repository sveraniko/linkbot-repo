# ASK‚ÄëWIZARD v3 ‚Äî Sprint Breakdown (Memory –≤–Ω—É—Ç—Ä–∏ ASK, –µ–¥–∏–Ω—ã–π –ø–æ—Ç–æ–∫)

> –¶–µ–ª—å —Å–ø—Ä–∏–Ω—Ç–∞: –¥–æ–≤–µ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç –¥–æ **–µ–¥–∏–Ω–æ–≥–æ –º–∞—Å—Ç–µ—Ä–∞**: Memory –≤—Å—Ç—Ä–æ–µ–Ω –≤ ASK, –ø–æ–∏—Å–∫ –∂–∏–≤—ë—Ç –Ω–∞ List, ¬´–ø–ª–∞—à–∫–∏ + –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ –∫–Ω–æ–ø–æ–∫¬ª, **–º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π** `‚ûï‚Üí‚úÖ`, **5/—Å—Ç—Ä–∞–Ω–∏—Ü–∞**, **LLM –∑–∞–ø—Ä–µ—â—ë–Ω**, Linked‚Äë–ø—Ä–∞–≤–∏–ª–∞ –∏ Auto‚Äëclear.  
> –í—ã–ø–æ–ª–Ω—è—Ç—å –ø–æ —à–∞–≥–∞–º. –ö–∞–∂–¥—ã–π —à–∞–≥ ‚Äî –º–∞–ª–µ–Ω—å–∫–∏–π PR. –í –∫–æ–Ω—Ü–µ —á–µ–∫‚Äë–ª–∏—Å—Ç –ø—Ä–∏—ë–º–∫–∏.

---

## 0) –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (–æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ)

**–ì–¥–µ:** `app/handlers/ask.py`, `app/handlers/memory_panel.py`, `app/services/memory.py`, `app/keyboards/ui.py` (–∏–ª–∏ –≤–∞—à –º–æ–¥—É–ª—å –∫–æ–Ω—Å—Ç–∞–Ω—Ç).

- –°–æ–∑–¥–∞—Ç—å UI‚Äë–∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã (–∏–∫–æ–Ω–∫–∏/—Ç–µ–∫—Å—Ç—ã): `PLUS="‚ûï"`, `SELECTED="‚úÖ"`, `DEL="üóë"`, `PREV="‚¨ÖÔ∏è"`, `NEXT="‚û°Ô∏è"`.
- –í `user_state` —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –µ—Å—Ç—å:  
  `selected_artifact_ids: list[int]`, `awaiting_ask_search: bool`, `ask_page: int`, `ask_page_msg_ids: list[int]`, `ask_footer_msg_id: int`, `ask_filter: dict`, `active_project_id`, `linked_project_ids`, `auto_clear_selection: bool`.  
  –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî **–º–∏–≥—Ä–∞—Ü–∏—è** —Å `NOT NULL DEFAULT`.

---

## 1) Reply‚Äë–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ ‚Üí –∫–æ—Ä–æ—Ç–∫–∞—è (ASK‚Äë—Ü–µ–Ω—Ç—Ä–∏—á–Ω–∞—è)

**–ì–¥–µ:** –º–æ–¥—É–ª—å —Å Reply‚Äë–∫–ª–∞–≤–æ–π.

- –û—Å—Ç–∞–≤–∏—Ç—å **3** –∫–Ω–æ–ø–∫–∏: `‚öôÔ∏è Actions | üí¨ Chat ON/OFF | ‚ùì ASK‚ÄëWIZARD`.
- –ö–Ω–æ–ø–∫—É **Memory** —É–±—Ä–∞—Ç—å (Memory –±—É–¥–µ—Ç –≤–Ω—É—Ç—Ä–∏ ASK).

**–ü—Ä–æ–≤–µ—Ä–∫–∞:** –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –≤—Å–µ–≥–¥–∞ –Ω–∞ —ç–∫—Ä–∞–Ω–µ, –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –æ–¥–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–µ–π.

---

## 2) ASK‚ÄëHome (–¥–æ–º –º–∞—Å—Ç–µ—Ä–∞)

**–ì–¥–µ:** `app/handlers/ask.py`

- –†–µ–Ω–¥–µ—Ä –¥–æ–º–∞—à–Ω–µ–π –ø–∞–Ω–µ–ª–∏:  
  `üîç –ü–æ–∏—Å–∫` (–≤–µ–¥—ë—Ç –Ω–∞ —ç–∫—Ä–∞–Ω List), `Auto‚Äëclear: ON/OFF`, `üßπ –°–±—Ä–æ—Å`, `üì• Import last`, –ø–ª–∞—à–∫–∞ **–ë—é–¥–∂–µ—Ç: ~N —Ç–æ–∫–µ–Ω–æ–≤**.
- –ö–Ω–æ–ø–∫–∞ `‚ùì Ask` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è **—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏** `selected_artifact_ids` –Ω–µ –ø—É—Å—Ç.

**–í–∞–∂–Ω–æ:** –Ω–∏–∫–∞–∫–∏—Ö –≤—ã–∑–æ–≤–æ–≤ LLM –Ω–∞ —ç—Ç–æ–º —ç–∫—Ä–∞–Ω–µ.

---

## 3) –≠–∫—Ä–∞–Ω **List** = —Å–µ—Ä–¥—Ü–µ –º–∞—Å—Ç–µ—Ä–∞ (–≤–∫–ª—é—á–∞—è –ø–æ–∏—Å–∫ –≤ —à–∞–ø–∫–µ)

**–ì–¥–µ:** `app/handlers/ask.py`

### 3.1 –®–∞–ø–∫–∞ –∏ ForceReply
- –ö–Ω–æ–ø–∫–∞ `ask:list:search` —Ä–∏—Å—É–µ—Ç —à–∞–ø–∫—É –∏ –≤—ã–∑—ã–≤–∞–µ—Ç ForceReply:  
  _¬´–í–≤–µ–¥–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ, #—Ç–µ–≥ –∏–ª–∏ id¬ª_.  
- –í `ask_search_reply` (–æ—Ç–≤–µ—Ç –Ω–∞ ForceReply): —Ä–∞–∑–æ–±—Ä–∞—Ç—å –≤–≤–æ–¥:  
  `^\d+$ ‚Üí mode=id`, `^#(.+)$ ‚Üí mode=tag`, –∏–Ω–∞—á–µ `mode=name`.  
  –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ `ask_filter`, `ask_page=1`. –£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

### 3.2 –¢–µ–ª–æ (–ø–ª–∞—à–∫–∏)
- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å **—Ä–æ–≤–Ω–æ 5** –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤, **–∫–∞–∂–¥—ã–π ‚Äî –æ—Ç–¥–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ** —Å —Ç–µ–∫—Å—Ç–æ–º:  
  `N. <–ù–∞–∑–≤–∞–Ω–∏–µ> [#tag1 #tag2] (id 689‚Ä¶, 2025‚Äë09‚Äë16)` (—ç—Ç–æ **–Ω–µ –∫–Ω–æ–ø–∫–∞**).
- –ü–æ–¥ –∫–∞–∂–¥–æ–π –ø–ª–∞—à–∫–æ–π ‚Äî **–û–î–ù–ê —Å—Ç—Ä–æ–∫–∞** –∏–Ω–ª–∞–π–Ω‚Äë–∫–Ω–æ–ø–æ–∫: `[‚ûï/‚úÖ, üóë]`.

### 3.3 –§—É—Ç–µ—Ä (–ø–∞–≥–∏–Ω–∞—Ü–∏—è)
- –û—Ç–¥–µ–ª—å–Ω–æ–µ —Ñ—É—Ç–µ—Ä‚Äë—Å–æ–æ–±—â–µ–Ω–∏–µ: `‚¨ÖÔ∏è  –°—Ç—Ä. X/Y  ‚û°Ô∏è`.  
- –ö–æ–ª–±—ç–∫–∏ `ask:prev` / `ask:next` –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞—é—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É.

### 3.4 –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
- –í —Å—Ç–µ–π—Ç–µ —Ö—Ä–∞–Ω–∏—Ç—å `ask_page_msg_ids` –∏ `ask_footer_msg_id`.  
- –ü—Ä–∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–µ **—É–¥–∞–ª—è—Ç—å** —Å—Ç–∞—Ä—ã–µ 5 –ø–ª–∞—à–µ–∫ + —Ñ—É—Ç–µ—Ä, –∑–∞—Ç–µ–º —Ä–∏—Å–æ–≤–∞—Ç—å –Ω–æ–≤—ã–µ.

**–ì–æ—Ç–æ–≤—ã–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã:**

```python
# --- –ø–∞—Ä—Å–µ—Ä ---
import re
def _parse_search_query(text: str):
    q = (text or "").strip()
    if not q: return {"mode": None, "term": None, "artifact_id": None}
    if re.fullmatch(r"\d+", q): return {"mode":"id","artifact_id":int(q),"term":None}
    m = re.fullmatch(r"#\s*(.+)", q)
    if m: return {"mode":"tag","term":m.group(1).strip().lower(),"artifact_id":None}
    return {"mode":"name","term":q.lower(),"artifact_id":None}
```

```python
# --- —Ç—É–º–±–ª–µ—Ä –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –ø–æ–¥ –ø–ª–∞—à–∫–æ–π ---
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton

def _item_kb(artifact_id: int, selected: bool) -> InlineKeyboardMarkup:
    toggle = "‚úÖ" if selected else "‚ûï"
    return InlineKeyboardMarkup(inline_keyboard=[[
        InlineKeyboardButton(text=toggle, callback_data=f"ask:toggle:{artifact_id}"),
        InlineKeyboardButton(text="üóë", callback_data=f"ask:del:{artifact_id}"),
    ]])
```

```python
# --- –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π —Ç—É–º–±–ª–µ—Ä ---
@router.callback_query(F.data.startswith("ask:toggle:"))
async def ask_toggle(cb: CallbackQuery, state: FSMContext):
    aid = int(cb.data.split(":")[-1])
    data = await state.get_data()
    selected = set(data.get("selected_artifact_ids", []))
    selected.symmetric_difference_update({aid})
    await state.update_data(selected_artifact_ids=list(selected))
    await cb.message.edit_reply_markup(reply_markup=_item_kb(aid, aid in selected))
    await cb.answer("–û–±–Ω–æ–≤–ª–µ–Ω–æ")
```

---

## 4) –í—ã–±–æ—Ä–∫–∞ –∏–∑ –ë–î –±–µ–∑ –¥—É–±–ª–µ–π (Variant B)

**–ì–¥–µ:** `app/services/memory.py` (–∏–ª–∏ `services/artifacts.py`)

- –û–±–ª–∞—Å—Ç—å –ø—Ä–æ–µ–∫—Ç–æ–≤: `project_ids = [active_project_id] + linked_project_ids`.  
- **–ü–æ–¥–∑–∞–ø—Ä–æ—Å —Å `distinct id`** –∏ –≤—Å–µ–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ (–≤ —Ç.—á. —Ç–µ–≥):  
  –≤–Ω–µ—à–Ω–∏–π –∑–∞–ø—Ä–æ—Å –ø–æ `id in (sub)` + `order by created_at desc` + `limit/offset`.
- –ù–∞ UI‚Äë—É—Ä–æ–≤–Ω–µ –ø–µ—Ä–µ–¥ —Ä–µ–Ω–¥–µ—Ä–æ–º ‚Äî **—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞** —É–Ω–∏–∫–∞–ª–∏–∑–∞—Ü–∏–µ–π –ø–æ `id`.

```python
# —ç—Å–∫–∏–∑
sub = select(Artifact.id).where(Artifact.project_id.in_(project_ids))
if mode=="id": sub = sub.where(Artifact.id==artifact_id)
elif mode=="tag": sub = select(Artifact.id).join(ArtifactTag)...where(lower(Tag.name).like(f"%{term}%"))
elif mode=="name": sub = sub.where(lower(Artifact.title).like(f"%{term}%"))
sub = sub.distinct()
main = select(Artifact).where(Artifact.id.in_(sub)).order_by(Artifact.created_at.desc()).limit(5).offset((page-1)*5)
```

**–ó–∞–ø—Ä–µ—â–µ–Ω–æ:** `DISTINCT ON` —Å –Ω–µ–ø–æ–¥—Ö–æ–¥—è—â–∏–º `ORDER BY`.

---

## 5) Linked‚Äë–ø—Ä–æ–µ–∫—Ç—ã (–ø—Ä–∞–≤–∏–ª–æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø—Ä–∞–≤–æ–∫ —Å–æ—Å—Ç–∞–≤–∞)

**–ì–¥–µ:** `ask.py` (–±—ç–π–¥–∂ –∏ –ø–æ–¥—Å–∫–∞–∑–∫–∞), –≤–∞—à–∏ —Ö–µ–Ω–¥–ª–µ—Ä—ã –ø—Ä–æ–µ–∫—Ç–æ–≤.

- –ï—Å–ª–∏ `linked_project_ids` –Ω–µ –ø—É—Å—Ç ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –±–µ–π–¥–∂ ¬´üîí Linked: ON¬ª –∏ –Ω–µ –¥–∞–≤–∞—Ç—å –º–µ–Ω—è—Ç—å **—Å–æ—Å—Ç–∞–≤ —á–∞—Ç–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞** (read‚Äëonly).  
- –í—ã–±–æ—Ä –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ (`‚ûï/‚úÖ`) **—Ä–∞–∑—Ä–µ—à—ë–Ω**, –æ–Ω –Ω–µ –º–µ–Ω—è–µ—Ç –∫–∞—Ç–∞–ª–æ–≥ –ø—Ä–æ–µ–∫—Ç–∞.

---

## 6) Auto‚Äëclear ‚Äî —Å–µ–º–∞–Ω—Ç–∏–∫–∞

**–ì–¥–µ:** `ask.py`

- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å `Auto‚Äëclear: ON/OFF` –≤–ª–∏—è–µ—Ç **—Ç–æ–ª—å–∫–æ** –Ω–∞ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è `‚ùì Ask`:  
  ON ‚Äî `selected_artifact_ids` –æ—á–∏—â–∞–µ—Ç—Å—è; OFF ‚Äî —Å–ø–∏—Å–æ–∫ –æ—Å—Ç–∞—ë—Ç—Å—è.

---

## 7) –ù–û–õ–¨ LLM –≤ —ç—Ç–æ–º –ø–æ—Ç–æ–∫–µ

- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `ask:list`, `ask:search`, `ask:prev/next`, `ask:toggle`, `ask:del` **–Ω–∏–∫–æ–≥–¥–∞** –Ω–µ –∑–æ–≤—É—Ç LLM.  
- Catch‚Äëall –º–æ–ª—á–∏—Ç, –µ—Å–ª–∏ `awaiting_ask_search=True`.

---

## 8) –ß–µ–∫‚Äë–ª–∏—Å—Ç –ø—Ä–∏—ë–º–∫–∏

1) Reply‚Äë–∫–ª–∞–≤–∞: `Actions | Chat | ASK‚ÄëWIZARD` (–±–µ–∑ Memory).  
2) ASK‚ÄëHome –æ—Ç—Ä–∏—Å–æ–≤–∞–Ω, `‚ùì Ask` –≤–∏–¥–µ–Ω —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–∞—Ö, –±—é–¥–∂–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è.  
3) List: 5 –ø–ª–∞—à–µ–∫; –ø–æ–¥ –∫–∞–∂–¥–æ–π **–æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞** `‚ûï/‚úÖ, üóë`.  
4) `plan` ‚Üí –∏—â–µ—Ç –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é; `#woman` ‚Üí –ø–æ —Ç–µ–≥–∞–º; `12` ‚Üí –ø–æ id. Chat: OFF; LLM –Ω–µ –¥–µ—Ä–≥–∞–µ—Ç—Å—è.  
5) `‚ûï` –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ `‚úÖ` –º–≥–Ω–æ–≤–µ–Ω–Ω–æ; –æ–±—Ä–∞—Ç–Ω—ã–π –∫–ª–∏–∫ ‚Äî –æ–±—Ä–∞—Ç–Ω–æ.  
6) `‚¨ÖÔ∏è/‚û°Ô∏è` –≤—Å–µ–≥–¥–∞ –¥–µ—Ä–∂–∞—Ç –Ω–∞ —ç–∫—Ä–∞–Ω–µ —Ä–æ–≤–Ω–æ 5 –ø–ª–∞—à–µ–∫; —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ —Ñ—É—Ç–µ—Ä —É–¥–∞–ª—è—é—Ç—Å—è.  
7) Linked: –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–π –ª–∏–Ω–∫–æ–≤–∫–µ –Ω–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø—Ä–∞–≤–∏—Ç—å —Å–æ—Å—Ç–∞–≤ —á–∞—Ç–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞ (—Ç–æ–ª—å–∫–æ –≤—ã–±–∏—Ä–∞—Ç—å –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞).  
8) `Auto‚Äëclear: ON` ‚Äî –ø–æ—Å–ª–µ –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ `‚ùì Ask` –≤—ã–±–æ—Ä –æ—á–∏—â–∞–µ—Ç—Å—è; –ø—Ä–∏ OFF ‚Äî –æ—Å—Ç–∞—ë—Ç—Å—è.

---

## 9) –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ –æ—Ç–ª–∞–¥–∫–µ (–ª–æ–≥–∏)

- –í `ask_search_reply`: –ª–æ–≥ `mode/term/id`, `project_ids`, `user_id`.  
- –í `list_artifacts`: —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ `project_ids`, `mode`, `term`, `limit/offset`, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ id –¥–æ/–ø–æ—Å–ª–µ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏.  
- –ï—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî –ø–æ—á—Ç–∏ –≤—Å–µ–≥–¥–∞ `project_ids` –ø—É—Å—Ç–æ–π –∏–ª–∏ `mode=None`.

---

–ì–æ—Ç–æ–≤–æ. –í—ã–ø–æ–ª–Ω—è—Ç—å —à–∞–≥–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ, –º–µ—Ä–¥–∂–∏—Ç—å **–º–∞–ª–µ–Ω—å–∫–∏–º–∏ PR**. –í–æ–ø—Ä–æ—Å—ã ‚Äî –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö –∫ –∑–∞–¥–∞—á–∞–º.
