–ö–æ—Ä–æ—Ç–∫–∏–π –æ—Ç–≤–µ—Ç: **—Å–Ω–∞—á–∞–ª–∞ ‚Äú–∏—Å—á–µ–∑–∞—é—â–∏–µ –ø–ª–∞—à–∫–∏‚Äù**, –ø–æ—Ç–æ–º **—Ç–µ–≥–∏/–ø—Ä–µ—Å–µ—Ç—ã + –∞–≤—Ç–æ—Ç–µ–≥–∏/—á–∏—Å—Ç–∫–∞**, –∏ —É–∂–µ –ø–æ—Å–ª–µ ‚Äî **GitHub-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**.

–ü–æ—á–µ–º—É —Ç–∞–∫:

1. **–ò—Å—á–µ–∑–∞—é—â–∏–µ –ø–ª–∞—à–∫–∏ (modal) ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∏—Å–∫, –º–∞–∫—Å–∏–º—É–º –ø–æ–ª—å–∑—ã.**
   –≠—Ç–æ —á–∏—Å—Ç—ã–π UX-—Ñ–∏–∫—Å, —Ç—Ä–æ–≥–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤—ã–≤–æ–¥ –º–µ–Ω—é. –°—Ä–∞–∑—É –ø–µ—Ä–µ—Å—Ç–∞—ë—Ç –ø–ª–æ–¥–∏—Ç—å—Å—è –º—É—Å–æ—Ä –≤ —á–∞—Ç–µ, —Ä–∞–±–æ—Ç–∞—Ç—å –ø—Ä–∏—è—Ç–Ω–µ–µ. –ú—ã —É–∂–µ –¥–∞–ª–∏ —Ç–æ—á–Ω—ã–µ –ø–∞—Ç—á–∏ (`last_panel_msg_id` + `show_panel()`), –ø—Ä–∏–º–µ–Ω—è–µ—à—å –º–∏–≥—Ä–∞—Ü–∏—é –∏ –≥–æ—Ç–æ–≤–æ.

2. **–¢–µ–≥–∏ –∏ –ø–æ—Ä—è–¥–æ–∫ (–ø—Ä–µ—Å–µ—Ç—ã, –∞–≤—Ç–æ—Ç–µ–≥ –ø–æ –¥–∞—Ç–µ, .pmignore, cleanup –ø–æ –¥–∞—Ç–µ) ‚Äî –æ–ø–æ—Ä–∞ –¥–ª—è –ø–æ—Ä—è–¥–∫–∞.**

   * –ü—Ä–µ—Å–µ—Ç—ã/–∫–Ω–æ–ø–∫–∏ ‚Üí –º–µ–Ω—å—à–µ –¥—É–º–∞—Ç—å, –±—ã—Å—Ç—Ä–µ–µ –º–µ—Ç–∏—Ç—å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã.
   * –ê–≤—Ç–æ—Ç–µ–≥ `rel-YYYY-MM-DD` –ø—Ä–∏ –ª—é–±–æ–º –∏–º–ø–æ—Ä—Ç–µ ‚Üí –≤–∏–¥–Ω–æ ‚Äú—á—Ç–æ –Ω–æ–≤–æ–µ‚Äù, –ª–µ–≥–∫–æ —á–∏—Å—Ç–∏—Ç—å.
   * `.pmignore` ‚Üí –Ω–µ –∑–∞–ª—å—ë–º –≤ –ø–∞–º—è—Ç—å –º—É—Å–æ—Ä (`node_modules`, –∫–∞—Ä—Ç–∏–Ω–∫–∏ –∏ —Ç. –ø.).
   * `Cleanup by date` ‚Üí –±—ã—Å—Ç—Ä–æ —Ä–∞–∑–≥—Ä–µ–±–∞—Ç—å ‚Äú—Ö–≤–æ—Å—Ç—ã‚Äù.
     –≠—Ç–æ —É–ª—É—á—à–∞–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ –¥–∞–Ω–Ω—ã—Ö –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å.

3. **GitHub (Repo add/list/sync) ‚Äî –ø–æ—Å–ª–µ–¥–Ω–∏–º.**
   –≠—Ç–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —Å –Ω–∞–∏–±–æ–ª—å—à–∏–º ‚Äú—Ä–∞–¥–∏—É—Å–æ–º –ø–æ—Ä–∞–∂–µ–Ω–∏—è‚Äù: git –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ, —Ç–æ–∫–µ–Ω—ã/–ø—Ä–∞–≤–∞, —Å–µ—Ç—å, –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ —Ä–µ–ø—ã. –ö–æ–≥–¥–∞ UI/—Ç–µ–≥–∏ —Å—Ç–∞–±–∏–ª—å–Ω—ã, –ø–æ–¥–∫–ª—é—á–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ. –°—Ç–∞—Ä—Ç—É–π —Å –ø—É–±–ª–∏—á–Ω–æ–≥–æ —Ä–µ–ø–æ, –∑–∞—Ç–µ–º –¥–æ–±–∞–≤—å `GITHUB_TOKEN` (fine-grained, read-only).

---

## –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º—ã–π –ø–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π (–æ—á–µ–Ω—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ)

1. **–ü–æ—Å—Ç–∞–≤–∏—Ç—å –º–æ–¥–∞–ª—å–Ω—ã–µ –ø–ª–∞—à–∫–∏**

   * –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é `0007_last_panel_msg`.
   * –ó–∞–ª–∏—Ç—å `app/ui.py` –∏ –∑–∞–º–µ–Ω–∏—Ç—å –≤—ã–∑–æ–≤—ã –Ω–∞ `show_panel(...)` –≤ Actions/Projects/Sources/Scope/Export/Repo/Cleanup.
   * `alembic upgrade head` ‚Üí `linkbot` –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫.
   * –ü—Ä–æ–≤–µ—Ä–∫–∞: –æ—Ç–∫—Ä—ã—Ç—å ‚ÄúProjects‚Äù, –∑–∞—Ç–µ–º ‚ÄúScope‚Äù ‚Äî –ø—Ä–µ–¥—ã–¥—É—â–∞—è –ø–∞–Ω–µ–ª—å –∏—Å—á–µ–∑–∞–µ—Ç.

2. **–î–æ–≤–µ—Å—Ç–∏ —Ç–µ–≥–∏ –∏ –ø–æ—Ä—è–¥–æ–∫**

   * –í–∫–ª—é—á–∏—Ç—å **Tag-–ø–ª–∞—à–∫—É** (–ø—Ä–µ—Å–µ—Ç—ã + —Å–≤–æ–±–æ–¥–Ω—ã–π –≤–≤–æ–¥) –∏ —Ñ–∏–∫—Å ForceReply (–º—ã –¥–∞–ª–∏ —Ö–µ–Ω–¥–ª–µ—Ä—ã).
   * –í–∫–ª—é—á–∏—Ç—å **–∞–≤—Ç–æ—Ç–µ–≥ –¥–∞—Ç—ã** –ø—Ä–∏ –∏–º–ø–æ—Ä—Çe (`rel-YYYY-MM-DD`).
   * –ü–æ–¥–∫–ª—é—á–∏—Ç—å **.pmignore** –¥–ª—è ZIP (–∏ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏ –ø—Ä–∏ —Ä–µ–ø–æ-—Å–∏–Ω—Ö–µ).
   * –í–∫–ª—é—á–∏—Ç—å **Cleanup by date** (–∫–Ω–æ–ø–∫–∞ –≤ Actions).
   * –ü—Ä–æ–≤–µ—Ä–∫–∞: –∏–º–ø–æ—Ä—Ç–∏—Ä—É–π ZIP ‚Üí –≤ `/memory list` –≤–∏–¥–Ω–æ —Ç–µ–≥ –¥–∞—Ç—ã; –Ω–∞–∂–º–∏ ‚ÄúCleanup‚Äù –∏ —É–¥–∞–ª–∏ –ø–æ –¥–∞—Ç–µ.

3. **–≠–∫—Å–ø–æ—Ä—Ç**

   * ‚ÄúExport project / Export context‚Äù ‚Äî —É–±–µ–¥–∏—Å—å, —á—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–µ–∫—Ç, –æ—Ç–¥–∞—ë—Ç ZIP (–µ—Å—Ç—å –∑–∞—â–∏—Ç–∞ –æ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –ø—Ä–æ–µ–∫—Ç–∞).
   * –ë—ã—Å—Ç—Ä–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å: —ç–∫—Å–ø–æ—Ä—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Å —Ñ–∏–ª—å—Ç—Ä–æ–º `tags=summary` ‚Äî –ø–æ–ª—É—á–∏—à—å –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π –æ—Ç—á—ë—Ç.

4. **GitHub**

   * –£–±–µ–¥–∏—Å—å, —á—Ç–æ –æ–±—Ä–∞–∑ –±–æ—Ç–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç `git`, –µ—Å—Ç—å volume `/app/repos`.
   * –ö–Ω–æ–ø–∫–∏ **Repo ‚Üí Add/List/Sync/Remove**.
   * –î–ª—è –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö: –¥–æ–±–∞–≤–∏—Ç—å –≤ `.env` `GITHUB_TOKEN` (fine-grained, —Ç–æ–ª—å–∫–æ read access –∫ –Ω—É–∂–Ω–æ–º—É —Ä–µ–ø–æ).
   * –ü—Ä–æ–≤–µ—Ä–∫–∞: `Repo ‚Üí Add`, –∑–∞—Ç–µ–º `Sync` (–ø–æ–∫–∞–∂–µ—Ç –ª–æ–≥ `git`), –ø–æ—Å–ª–µ ‚Äî –∏–º–ø–æ—Ä—Ç —á–µ—Ä–µ–∑ ZIP/—Å–∏–Ω–∫-–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é –ø–æ diff (–µ—Å–ª–∏ –∑–∞—Ö–æ—Ç–∏–º —Ä–∞—Å—à–∏—Ä–∏—Ç—å).

---

## –ë–æ–Ω—É—Å: –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ ‚Äú—Ä—É–±–∏–ª—å–Ω–∏–∫–∏‚Äù

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å –≤–∫–ª—é—á–∞—Ç—å/–≤—ã–∫–ª—é—á–∞—Ç—å –∫—Ä—É–ø–Ω—ã–µ –±–ª–æ–∫–∏ –Ω–∞ –≤—Ä–µ–º—è —Ç–µ—Å—Ç–æ–≤ ‚Äî –¥–æ–±–∞–≤—å —Ñ–ª–∞–≥–∏ –≤ `.env`:

```
ENABLE_REPO=true
ENABLE_EXPORT=true
ENABLE_CLEANUP=true
```

–ò –≤ –∫–æ–¥–µ –ø—Ä–æ—Å—Ç–æ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –∫–Ω–æ–ø–∫–∏, –µ—Å–ª–∏ —Ñ–ª–∞–≥ `false`. –≠—Ç–æ —Å–Ω–∏–∂–∞–µ—Ç —Ä–∏—Å–∫, –∫–æ–≥–¥–∞ –æ—Ç–ª–∞–∂–∏–≤–∞–µ—à—å —á–∞—Å—Ç—è–º–∏.

---

—Å—É–ø–µ—Ä –∏–¥–µ—è ‚Äî ¬´–ø–ª–∞—à–∫–∏¬ª –¥–æ–ª–∂–Ω—ã –≤–µ—Å—Ç–∏ —Å–µ–±—è –∫–∞–∫ –º–æ–¥–∞–ª—å–Ω—ã–µ: –æ—Ç–∫—Ä—ã–ª–∞—Å—å –Ω–æ–≤–∞—è ‚Üí —Å—Ç–∞—Ä–∞—è –∏—Å—á–µ–∑–ª–∞. –î–µ–ª–∞–µ–º —ç—Ç–æ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –∏ –±–µ–∑ –ø–æ–±–æ—á–µ–∫.

–ù–∏–∂–µ ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ç–æ—á–Ω—ã–µ –ø—Ä–∞–≤–∫–∏: –æ–¥–Ω–∞ –Ω–æ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è id –ø–æ—Å–ª–µ–¥–Ω–µ–π ¬´–ø–∞–Ω–µ–ª–∏¬ª, —É—Ç–∏–ª–∏—Ç–∞ `show_panel()` –∏ –∑–∞–º–µ–Ω—ã –≤ —Ö–µ–Ω–¥–ª–µ—Ä–∞—Ö ¬´Projects / Sources / Scope / Export / Repo / Cleanup / Actions¬ª. –í—Å—Ç–∞–≤—å 1-–≤-1 –∏ –∑–∞–ø—É—Å—Ç–∏ –º–∏–≥—Ä–∞—Ü–∏—é.

---

# 1) Alembic: –∑–∞–ø–æ–º–Ω–∏–º ¬´–ø–æ—Å–ª–µ–¥–Ω—é—é –ø–∞–Ω–µ–ª—å¬ª

**`alembic/versions/0007_last_panel_msg.py`**

```python
from alembic import op
import sqlalchemy as sa

revision = "0007_last_panel_msg"
down_revision = "0006_tag_presets"  # –ø–æ–ø—Ä–∞–≤—å –µ—Å–ª–∏ –Ω–æ–º–µ—Ä –¥—Ä—É–≥–æ–π
branch_labels = None
depends_on = None

def upgrade():
    op.add_column("user_state", sa.Column("last_panel_msg_id", sa.Integer(), nullable=True))

def downgrade():
    op.drop_column("user_state", "last_panel_msg_id")
```

---

# 2) –ú–æ–¥–µ–ª—å

**`app/models.py`**

```diff
 class UserState(Base):
     __tablename__ = "user_state"
     user_id: Mapped[int] = mapped_column(BigInteger, primary_key=True)
     active_project_id: Mapped[int | None] = mapped_column(ForeignKey("projects.id", ondelete="SET NULL"), nullable=True)
     preferred_model: Mapped[str] = mapped_column(String(32), default="gpt-5")
     chat_mode: Mapped[bool] = mapped_column(Boolean, default=False)
     quiet_mode: Mapped[bool] = mapped_column(Boolean, default=False)
     sources_mode: Mapped[str] = mapped_column(String(16), default="active")
     scope_mode: Mapped[str] = mapped_column(String(16), default="auto")
     context_kinds: Mapped[str | None] = mapped_column(String(256))
     context_tags: Mapped[str | None] = mapped_column(String(256))
     created_at: Mapped[DateTime] = mapped_column(DateTime(timezone=True), server_default=func.now())
+    last_panel_msg_id: Mapped[int | None] = mapped_column(Integer, nullable=True)
```

---

# 3) –£—Ç–∏–ª–∏—Ç–∞ ¬´–º–æ–¥–∞–ª—å–Ω–æ–π¬ª –ø–∞–Ω–µ–ª–∏

**`app/ui.py`** (–Ω–æ–≤—ã–π —Ñ–∞–π–ª)

```python
from __future__ import annotations
from aiogram import Bot
from aiogram.types import InlineKeyboardMarkup
from sqlalchemy.ext.asyncio import AsyncSession
from app.services.memory import _ensure_user_state

async def show_panel(st: AsyncSession, bot: Bot, chat_id: int, user_id: int, text: str, kb: InlineKeyboardMarkup):
    """
    –£–¥–∞–ª—è–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â—É—é ¬´–ø–∞–Ω–µ–ª—å¬ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø—Ä–∏—Å—ã–ª–∞–µ—Ç –Ω–æ–≤—É—é.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç Message (aiogram).
    """
    stt = await _ensure_user_state(st, user_id)
    old_id = stt.last_panel_msg_id
    if old_id:
        try:
            await bot.delete_message(chat_id, old_id)
        except Exception:
            # –º–æ–≥ –±—ã—Ç—å —É–∂–µ —É–¥–∞–ª—ë–Ω/–æ—á–∏—â–µ–Ω ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
            pass

    sent = await bot.send_message(chat_id, text, reply_markup=kb)
    stt.last_panel_msg_id = sent.message_id
    await st.flush()
    return sent
```

---

# 4) –ú–µ–Ω—è–µ–º –≤—Å–µ ¬´–ø–∞–Ω–µ–ª–∏¬ª –Ω–∞ show\_panel()

## 4.1 Actions (–≥–ª–∞–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å)

**`app/handlers/keyboard.py`** (–∫–Ω–æ–ø–∫–∞ ‚öôÔ∏è Actions)

```diff
 @router.message(F.text == BTN_ACTIONS)
 async def kb_actions(message: Message):
-    from app.handlers.menu import kb_menu  # –∏–º–ø–æ—Ä—Ç –≤–Ω—É—Ç—Ä–∏, —á—Ç–æ–±—ã –Ω–µ –ª–æ–≤–∏—Ç—å —Ü–∏–∫–ª—ã
-    from app.services.memory import get_preferred_model
-    st = await anext(session)
-    model = await get_preferred_model(st, message.from_user.id)
-    await message.answer("–ü–∞–Ω–µ–ª—å –¥–µ–π—Å—Ç–≤–∏–π:", reply_markup=kb_menu(model))
+    from app.handlers.menu import kb_menu
+    from app.db import session_scope
+    from app.services.memory import get_preferred_model
+    from app.ui import show_panel
+    async with session_scope() as st:
+        model = await get_preferred_model(st, message.from_user.id)
+        await show_panel(st, message.bot, message.chat.id, message.from_user.id,
+                         "–ü–∞–Ω–µ–ª—å –¥–µ–π—Å—Ç–≤–∏–π:", kb_menu(model))
```

*(–µ—Å–ª–∏ —É —Ç–µ–±—è Actions –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ `/actions` ‚Äî –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ —Ç–∞–º.)*

## 4.2 Sources / Scope (–∫–Ω–æ–ø–æ—á–Ω—ã–µ –ø–ª–∞—à–∫–∏)

**`app/handlers/menu.py`**

```diff
 from app.db import session_scope
+from app.ui import show_panel
@@
 @router.callback_query(F.data == "sources:toggle")
 async def sources_toggle(cb: CallbackQuery):
     async with session_scope() as st:
         from app.services.memory import get_chat_flags
         _, _, current, _ = await get_chat_flags(st, cb.from_user.id)
-    kb = build_sources_kb(current)
-    await cb.message.answer("–í—ã–±–µ—Ä–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ (Sources):", reply_markup=kb)
+        kb = build_sources_kb(current)
+        await show_panel(st, cb.message.bot, cb.message.chat.id, cb.from_user.id,
+                         "–í—ã–±–µ—Ä–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ (Sources):", kb)
     await cb.answer()
@@
 @router.callback_query(F.data == "scope:toggle")
 async def scope_toggle(cb: CallbackQuery):
     async with session_scope() as st:
         _, _, _, current = await get_chat_flags(st, cb.from_user.id)
-    kb = build_scope_kb(current)
-    await cb.message.answer("–í—ã–±–µ—Ä–∏ –æ–±–ª–∞—Å—Ç—å –æ—Ç–≤–µ—Ç–∞ (Scope):", reply_markup=kb)
+        kb = build_scope_kb(current)
+        await show_panel(st, cb.message.bot, cb.message.chat.id, cb.from_user.id,
+                         "–í—ã–±–µ—Ä–∏ –æ–±–ª–∞—Å—Ç—å –æ—Ç–≤–µ—Ç–∞ (Scope):", kb)
     await cb.answer()
```

*(–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ `sources:set:*` / `scope:set:*` –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å ‚Äî –æ–Ω–∏ –∫–æ—Ä–æ—Ç–∫–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—Ç –∏ —á–∞—Ç –Ω–µ –∑–∞—Ö–ª–∞–º–ª—è—é—Ç.)*

## 4.3 Projects

```diff
 @router.callback_query(F.data.startswith("projects:list"))
 async def projects_list(cb: CallbackQuery):
     async with session_scope() as st:
         allp = await list_projects(st)
         linked = set(await get_linked_project_ids(st, cb.from_user.id))
         cur = await get_active_project(st, cb.from_user.id)
-        kb = build_projects_page(allp, linked, cur.id if cur else None)
-    await cb.message.answer("–ü—Ä–æ–µ–∫—Ç—ã:", reply_markup=kb)
+        kb = build_projects_page(allp, linked, cur.id if cur else None)
+        await show_panel(st, cb.message.bot, cb.message.chat.id, cb.from_user.id,
+                         "–ü—Ä–æ–µ–∫—Ç—ã:", kb)
     await cb.answer()
```

*(–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ `projects:link:*` –∏ `projects:activate:*` –æ—Å—Ç–∞–≤—å —Å `edit_reply_markup` ‚Äî –æ–Ω–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç —Ç—É –∂–µ –ø–ª–∞—à–∫—É.)*

## 4.4 Export / Repo / Cleanup

**`app/handlers/export.py`**

```diff
 from app.db import session_scope
+from app.ui import show_panel
@@
 @router.callback_query(F.data == "export:open")
 async def export_open(cb: CallbackQuery):
     async with session_scope() as st:
         proj = await get_active_project(st, cb.from_user.id)
         if not proj:
             await cb.message.answer("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –ø—Ä–æ–µ–∫—Ç: Actions ‚Üí Projects.")
             return await cb.answer()
         kb = build_export_kb(proj.name)
-    await cb.message.answer("–≠–∫—Å–ø–æ—Ä—Ç:", reply_markup=kb)
+        await show_panel(st, cb.message.bot, cb.message.chat.id, cb.from_user.id,
+                         "–≠–∫—Å–ø–æ—Ä—Ç:", kb)
     await cb.answer()
```

**`app/handlers/repo.py`**

```diff
 from app.db import session_scope
+from app.ui import show_panel
@@
 @router.callback_query(F.data == "repo:open")
 async def repo_open(cb: CallbackQuery):
-    await cb.message.answer("Repo:", reply_markup=repo_menu_kb()); await cb.answer()
+    async with session_scope() as st:
+        await show_panel(st, cb.message.bot, cb.message.chat.id, cb.from_user.id,
+                         "Repo:", repo_menu_kb())
+    await cb.answer()
```

**`app/handlers/cleanup.py`**

```diff
 from app.db import session_scope
+from app.ui import show_panel
@@
 @router.callback_query(F.data == "cleanup:open")
 async def cleanup_open(cb: CallbackQuery):
-    await cb.message.answer(
-        "–£–¥–∞–ª–∏—Ç—å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –ü–û –î–ê–¢–ï.\n"
-        "–í–≤–µ–¥–∏ –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD (—É–¥–∞–ª–∏–º —Å —ç—Ç–æ–π –¥–∞—Ç—ã –∏ –ø–æ–∑–∂–µ).",
-        reply_markup=ForceReply(selective=True)
-    )
+    async with session_scope() as st:
+        await show_panel(
+            st, cb.message.bot, cb.message.chat.id, cb.from_user.id,
+            "–£–¥–∞–ª–∏—Ç—å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –ü–û –î–ê–¢–ï.\n"
+            "–í–≤–µ–¥–∏ –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD (—É–¥–∞–ª–∏–º —Å —ç—Ç–æ–π –¥–∞—Ç—ã –∏ –ø–æ–∑–∂–µ).",
+            None
+        )
+    await cb.message.answer("–û—Ç–≤–µ—Ç—å —ç—Ç–æ–π –¥–∞—Ç–æ–π –≤ —Ä–µ–ø–ª–∞–µ –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é.", reply_markup=ForceReply(selective=True))
     await cb.answer()
```

*(—Ç—É—Ç –º—ã —Ö—Ä–∞–Ω–∏–º ¬´–ø–∞–Ω–µ–ª—å–Ω–æ–µ¬ª —Å–æ–æ–±—â–µ–Ω–∏–µ, –∞ ForceReply ‚Äî –æ—Ç–¥–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ.)*

---

# 5) –ú–∏–≥—Ä–∞—Ü–∏—è –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫

```powershell
docker compose --env-file .env run --rm bot alembic upgrade head
linkbot
```

---

## –ö–∞–∫ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç

* –ù–∞–∂–∞–ª ¬´Projects¬ª ‚Üí –ø–æ—è–≤–∏–ª–∞—Å—å –ø–ª–∞—à–∫–∞ ¬´–ü—Ä–æ–µ–∫—Ç—ã¬ª.
* –ù–∞–∂–∞–ª ¬´Scope¬ª ‚Üí **–ø—Ä–µ–¥—ã–¥—É—â–∞—è –ø–ª–∞—à–∫–∞ —É–¥–∞–ª–µ–Ω–∞**, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è ¬´Scope¬ª.
* –õ—é–±–∞—è ¬´–ø–∞–Ω–µ–ª—å–Ω–∞—è¬ª –∫–Ω–æ–ø–∫–∞ (Actions / Projects / Sources / Scope / Export / Repo / Cleanup) –≤—Å–µ–≥–¥–∞ **–æ—á–∏—â–∞–µ—Ç** –ø—Ä–µ–¥—ã–¥—É—â—É—é –ø–∞–Ω–µ–ª—å —É –¥–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —á—Ç–æ–±—ã —á–∞—Ç –Ω–µ —Ä–∞–∑—Ä–∞—Å—Ç–∞–ª—Å—è.

–ï—Å–ª–∏ –≥–¥–µ-—Ç–æ —É–≤–∏–¥–∏—à—å —Å—Ç–∞—Ä—É—é –ø–ª–∞—à–∫—É, –∫–æ—Ç–æ—Ä—É—é –Ω–µ —Å—Ç–∏—Ä–∞–µ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ —Ä–µ–¥–∫–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–º —Ö–µ–Ω–¥–ª–µ—Ä–µ) ‚Äî —Å–∫–∞–∂–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏, –¥–æ–±–∞–≤–ª—é `show_panel` —Ç—É–¥–∞ –∂–µ.

–î–µ–ª–∞–µ–º ¬´–∞–Ω—Ç–∏–¥—É—Ä–∞–∫¬ª –∏ –¥–æ–≤–æ–¥–∏–º –¥–æ —Ä–∞–±–æ—á–µ–≥–æ UX: Export —Å —è–≤–Ω—ã–º –ø—Ä–æ–µ–∫—Ç–æ–º, Repo –∫–∞–∫ –ø–ª–∞—à–∫–∞ —Å –∫–Ω–æ–ø–∫–∞–º–∏ + git-sync, .pmignore, –∞–≤—Ç–æ—Ç–µ–≥ –¥–∞—Ç—ã (`rel-YYYY-MM-DD`) –Ω–∞ –∏–º–ø–æ—Ä—Ç, ¬´—á–∏—Å—Ç–∫–∞ –ø–æ –¥–∞—Ç–µ¬ª, –ø–∞–≥–∏–Ω–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–æ–≤, –ø—Ä–µ—Å–µ—Ç—ã —Ç–µ–≥–æ–≤ + —Å–≤–æ–±–æ–¥–Ω—ã–π –≤–≤–æ–¥, –∏ –≤—ã–±–æ—Ä **Scope** –∫–Ω–æ–ø–∫–∞–º–∏.

–ù–∏–∂–µ ‚Äî –≥–æ—Ç–æ–≤—ã–µ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø–∞—Ç—á–∏. –í—Å—Ç–∞–≤–ª—è–π 1-–≤-1 –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–π `linkbot`.

---

# 0) –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ Docker

**`requirements.txt`**

```
pathspec>=0.12.1   # .pmignore
```

**`Dockerfile`** (–∏–ª–∏ `bot`-image): –¥–æ–±–∞–≤—å git

```dockerfile
RUN apt-get update && apt-get install -y git && rm -rf /var/lib/apt/lists/*
```

**`.env`**

```
GITHUB_TOKEN=ghp_xxx   # –µ—Å–ª–∏ –Ω—É–∂–Ω—ã –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ (optional)
```

**`docker-compose.yml`** ‚Äî —Ç–æ–º –ø–æ–¥ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏

```yaml
services:
  bot:
    volumes:
      - repos_data:/app/repos   # –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à git
volumes:
  repos_data:
```

---

# 1) .pmignore: —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è —à—É–º–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤

**`app/ignore.py`** (–Ω–æ–≤—ã–π)

```python
from __future__ import annotations
from pathlib import Path
from typing import Iterable
from pathspec import PathSpec

DEFAULT_PMIGNORE = """
# –ø–∞–ø–∫–∏
node_modules/
dist/
build/
.cache/
.venv/
venv/
.git/
__pycache__/
# —Ñ–∞–π–ª—ã
*.png
*.jpg
*.jpeg
*.gif
*.webp
*.mp4
*.pdf
*.zip
*.tar
*.log
"""

def load_pmignore(root: Path, extra_patterns: Iterable[str] | None = None) -> PathSpec:
    patts: list[str] = []
    pm = root / ".pmignore"
    if pm.exists():
        patts += pm.read_text(encoding="utf-8", errors="ignore").splitlines()
    else:
        patts += DEFAULT_PMIGNORE.splitlines()
    if extra_patterns:
        patts += list(extra_patterns)
    return PathSpec.from_lines("gitwildmatch", patts)

def iter_text_files(root: Path, spec: PathSpec):
    for p in root.rglob("*"):
        if p.is_file():
            rel = p.relative_to(root).as_posix()
            if spec.match_file(rel):
                continue
            # –ø—Ä–æ—Å—Ç–∞—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞ ¬´—Ç–µ–∫—Å—Ç/–Ω–µ—Ç¬ª
            try:
                data = p.read_bytes()
                data.decode("utf-8")
            except Exception:
                continue
            yield rel, data.decode("utf-8", errors="ignore")
```

---

# 2) –ò–º–ø–æ—Ä—Ç: –∞–≤—Ç–æ—Ç–µ–≥ –¥–∞—Ç—ã `rel-YYYY-MM-DD`

**`app/handlers/import_file.py`** ‚Äî –¥–æ–±–∞–≤–∏–º –∞–≤—Ç–æ—Ç–µ–≥ –∏ .pmignore –¥–ª—è ZIP

```diff
 from datetime import datetime
+from pathlib import Path
+from app.ignore import load_pmignore, iter_text_files

 @router.message(Command("import"), F.reply_to_message)
 async def import_document(...):
     ...
-    await create_import(st, proj, title=title, text=text, chunk_size=settings.chunk_size, overlap=settings.chunk_overlap)
+    date_tag = f"rel-{datetime.utcnow().date().isoformat()}"
+    await create_import(st, proj, title=title, text=text,
+                        chunk_size=settings.chunk_size, overlap=settings.chunk_overlap,
+                        tags=[date_tag])  # –∞–≤—Ç–æ—Ç–µ–≥ –¥–∞—Ç—ã
     await st.commit()
     ...

 # ZIP –∏–º–ø–æ—Ä—Ç (–µ—Å–ª–∏ —É —Ç–µ–±—è –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ö–µ–Ω–¥–ª–µ—Ä ‚Äî –¥–æ–ø–æ–ª–Ω–∏ –µ–≥–æ —Ç–∞–∫)
 @router.message(Command("importzip"), F.reply_to_message)
 async def import_zip(message: Message, ...):
     ...
     # —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏ zip –≤ MinIO ‚Üí data = –±–∞–π—Ç—ã –∞—Ä—Ö–∏–≤–∞
     tmp = Path("/tmp/pm_zip")
     if tmp.exists():
         import shutil; shutil.rmtree(tmp)
     tmp.mkdir(parents=True, exist_ok=True)

     # —Ä–∞—Å–ø–∞–∫–æ–≤–∞—Ç—å
     import zipfile, io
     with zipfile.ZipFile(io.BytesIO(data)) as z:
         z.extractall(tmp)

     spec = load_pmignore(tmp)
     date_tag = f"rel-{datetime.utcnow().date().isoformat()}"
     imported = 0
     for rel, text in iter_text_files(tmp, spec):
         title = f"{doc.file_name}:{rel}"
         await create_import(st, proj, title=title, text=text,
                             chunk_size=settings.chunk_size, overlap=settings.chunk_overlap,
                             tags=[date_tag])
         imported += 1
     await st.commit()
     await message.answer(f"–ò–º–ø–æ—Ä—Ç ZIP –∑–∞–≤–µ—Ä—à—ë–Ω: {imported} —Ñ–∞–π–ª–æ–≤.\n–¢–µ–≥: <code>{date_tag}</code>")
```

> –¢–µ–ø–µ—Ä—å –ª—é–±–æ–π –∏–º–ø–æ—Ä—Ç (txt/md/json –∏ –∏–∑ ZIP) –ø–æ–º–µ—á–∞–µ—Ç—Å—è —Ç–µ–≥–æ–º –≤–∏–¥–∞ `rel-2025-09-13`. –≠—Ç–æ —É–ø—Ä–æ—â–∞–µ—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –∏ ¬´—á–∏—Å—Ç–∫–∏¬ª.

---

# 3) –ß–∏—Å—Ç–∫–∞ –ø–æ –¥–∞—Ç–µ (—É–¥–∞–ª–∏—Ç—å –≤—Å—ë ¬´—Å —Ç–∞–∫–æ–π-—Ç–æ –¥–∞—Ç—ã¬ª)

**`app/handlers/cleanup.py`** (–Ω–æ–≤—ã–π)

```python
from __future__ import annotations
import re, datetime as dt
from aiogram import Router, F
from aiogram.types import CallbackQuery, Message, ForceReply, InlineKeyboardMarkup, InlineKeyboardButton
import sqlalchemy as sa
from sqlalchemy.ext.asyncio import AsyncSession
from app.db import session_scope
from app.services.memory import get_active_project
from app.models import Artifact

router = Router()

@router.callback_query(F.data == "cleanup:open")
async def cleanup_open(cb: CallbackQuery):
    await cb.message.answer(
        "–£–¥–∞–ª–∏—Ç—å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –ü–û –î–ê–¢–ï.\n"
        "–í–≤–µ–¥–∏ –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD (—É–¥–∞–ª–∏–º —Å —ç—Ç–æ–π –¥–∞—Ç—ã –∏ –ø–æ–∑–∂–µ).",
        reply_markup=ForceReply(selective=True)
    )
    await cb.answer()

@router.message(F.reply_to_message & F.reply_to_message.text.startswith("–£–¥–∞–ª–∏—Ç—å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –ü–û –î–ê–¢–ï"))
async def cleanup_reply(message: Message):
    m = re.search(r"(\d{4}-\d{2}-\d{2})", message.text or "")
    if not m:
        return await message.answer("–§–æ—Ä–º–∞—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π. –ü—Ä–∏–º–µ—Ä: 2025-09-13")
    try:
        d0 = dt.date.fromisoformat(m.group(1))
    except:
        return await message.answer("–î–∞—Ç–∞ –Ω–µ–≤–µ—Ä–Ω–∞—è.")
    async with session_scope() as st:
        proj = await get_active_project(st, message.from_user.id)
        if not proj:
            return await message.answer("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –ø—Ä–æ–µ–∫—Ç (Actions ‚Üí Projects).")
        # —É–¥–∞–ª–∏–º –≤—Å—ë –ø–æ created_at >= d0 –∏–ª–∏ –∏–º–µ—é—â–µ–µ —Ç–µ–≥ rel-d0/–ø–æ–∑–∂–µ ‚Äî –≤—ã–±–µ—Ä–µ–º –ø–æ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è:
        q = sa.delete(Artifact).where(
            Artifact.project_id == proj.id,
            Artifact.created_at >= dt.datetime.combine(d0, dt.time.min)
        )
        res = await st.execute(q); await st.commit()
    await message.answer(f"üßπ –£–¥–∞–ª–µ–Ω–æ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤: {res.rowcount or 0}")
```

–í **Actions** –¥–æ–±–∞–≤–∏–º –∫–Ω–æ–ø–∫—É ¬´üßπ Cleanup¬ª ‚Üí `cleanup:open` (—Å–º. –ø.6).

---

# 4) Export: ¬´–∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É—Ä–∞–∫–∞¬ª + –≤–∞—Ä–∏–∞–Ω—Ç—ã

**`app/exporter.py`** (–Ω–æ–≤—ã–π)

````python
from __future__ import annotations
import io, zipfile, datetime as dt
from typing import Iterable
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, and_
from app.models import Artifact, Project

async def export_project_zip(st: AsyncSession, project: Project, kinds: list[str] | None = None, tags: list[str] | None = None) -> bytes:
    buf = io.BytesIO()
    with zipfile.ZipFile(buf, "w", zipfile.ZIP_DEFLATED) as z:
        # markdown-d–∞–º–ø –≤—Å–µ–≥–æ
        md = ["# Export", f"Project: {project.name}", f"Date: {dt.datetime.utcnow().isoformat()}Z", ""]
        q = select(Artifact).where(Artifact.project_id == project.id).order_by(Artifact.created_at.asc())
        if kinds:
            q = q.where(Artifact.kind.in_(kinds))
        res = await st.execute(q)
        for a in res.scalars():
            md.append(f"## [{a.kind}] {a.title}  \n<small>{a.created_at}</small>\n\n```\n{a.raw_text}\n```")
        z.writestr("EXPORT.md", "\n".join(md))
    buf.seek(0)
    return buf.getvalue()
````

**`app/handlers/export.py`** (–Ω–æ–≤—ã–π)

```python
from __future__ import annotations
from aiogram import Router, F
from aiogram.types import CallbackQuery, InlineKeyboardMarkup, InlineKeyboardButton, FSInputFile
from app.db import session_scope
from app.services.memory import get_active_project, get_context_filters_state
from app.exporter import export_project_zip

router = Router()

def build_export_kb(project_name: str) -> InlineKeyboardMarkup:
    return InlineKeyboardMarkup(inline_keyboard=[[
        InlineKeyboardButton(text=f"üì¶ Export project ({project_name})", callback_data="export:project"),
        InlineKeyboardButton(text="üéØ Export context (filters)", callback_data="export:context"),
    ]])

@router.callback_query(F.data == "export:open")
async def export_open(cb: CallbackQuery):
    async with session_scope() as st:
        proj = await get_active_project(st, cb.from_user.id)
        if not proj:
            await cb.message.answer("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –ø—Ä–æ–µ–∫—Ç: Actions ‚Üí Projects.")
            return await cb.answer()
        kb = build_export_kb(proj.name)
    await cb.message.answer("–≠–∫—Å–ø–æ—Ä—Ç:", reply_markup=kb)
    await cb.answer()

@router.callback_query(F.data == "export:project")
async def export_project(cb: CallbackQuery):
    async with session_scope() as st:
        proj = await get_active_project(st, cb.from_user.id)
        if not proj:
            await cb.message.answer("–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞.")
            return await cb.answer()
        data = await export_project_zip(st, proj)
    path = "/tmp/pm_export.zip"
    with open(path, "wb") as f: f.write(data)
    await cb.message.answer_document(FSInputFile(path, filename=f"{proj.name}-export.zip"), caption=f"Export: {proj.name}")
    await cb.answer()

@router.callback_query(F.data == "export:context")
async def export_context(cb: CallbackQuery):
    async with session_scope() as st:
        proj = await get_active_project(st, cb.from_user.id)
        if not proj:
            await cb.message.answer("–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞.")
            return await cb.answer()
        kinds, tags = await get_context_filters_state(st, cb.from_user.id)
        data = await export_project_zip(st, proj, kinds=kinds or None, tags=tags or None)
    path = "/tmp/pm_ctx_export.zip"
    with open(path, "wb") as f: f.write(data)
    await cb.message.answer_document(FSInputFile(path, filename=f"{proj.name}-context.zip"), caption=f"Export (filters): {proj.name}")
    await cb.answer()
```

---

# 5) Repo: add/list/sync/remove (git-sync –ø–æ –∫–Ω–æ–ø–∫–µ)

**–ë–î: –º–∏–≥—Ä–∞—Ü–∏—è** `alembic/versions/0005_repos.py`

```python
from alembic import op
import sqlalchemy as sa

revision = "0005_repos"
down_revision = "0004_nullable_project_in_bot_messages"

def upgrade():
    op.create_table("repos",
        sa.Column("id", sa.Integer(), primary_key=True),
        sa.Column("user_id", sa.BigInteger(), nullable=False),
        sa.Column("alias", sa.String(64), nullable=False),
        sa.Column("url", sa.String(512), nullable=False),
        sa.Column("branch", sa.String(64), nullable=False, server_default="main"),
        sa.Column("last_synced_at", sa.DateTime(timezone=True), nullable=True),
        sa.UniqueConstraint("user_id","alias", name="uq_user_repo_alias")
    )

def downgrade():
    op.drop_table("repos")
```

**`app/models.py`** (–¥–æ–±–∞–≤—å –º–æ–¥–µ–ª—å)

```python
class Repo(Base):
    __tablename__ = "repos"
    id: Mapped[int] = mapped_column(primary_key=True)
    user_id: Mapped[int] = mapped_column(BigInteger)
    alias: Mapped[str] = mapped_column(String(64))
    url: Mapped[str] = mapped_column(String(512))
    branch: Mapped[str] = mapped_column(String(64), default="main")
    last_synced_at: Mapped[DateTime | None] = mapped_column(DateTime(timezone=True))
```

**`app/repo.py`** (–Ω–æ–≤—ã–π ‚Äî git CLI)

```python
from __future__ import annotations
import subprocess, os, shlex, datetime as dt
from pathlib import Path
from typing import Optional
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, delete
from app.models import Repo

BASE = Path("/app/repos")

def _runcmd(cmd: str, cwd: Optional[Path] = None) -> tuple[int, str]:
    p = subprocess.Popen(shlex.split(cmd), cwd=str(cwd) if cwd else None,
                         stdout=subprocess.PIPE, stderr=subprocess.STDOUT, text=True)
    out, _ = p.communicate()
    return p.returncode, out

async def repo_add(st: AsyncSession, user_id: int, alias: str, url: str, branch: str = "main"):
    r = Repo(user_id=user_id, alias=alias, url=url, branch=branch)
    st.add(r); await st.flush(); return r

async def repo_list(st: AsyncSession, user_id: int):
    res = await st.execute(select(Repo).where(Repo.user_id==user_id).order_by(Repo.alias.asc()))
    return list(res.scalars())

async def repo_remove(st: AsyncSession, user_id: int, alias: str):
    await st.execute(delete(Repo).where(Repo.user_id==user_id, Repo.alias==alias))

async def repo_sync(st: AsyncSession, user_id: int, alias: str, token: str | None = None) -> str:
    r = (await st.execute(select(Repo).where(Repo.user_id==user_id, Repo.alias==alias))).scalars().first()
    if not r: return "Repo not found."
    BASE.mkdir(parents=True, exist_ok=True)
    path = BASE / alias
    # URL —Å —Ç–æ–∫–µ–Ω–æ–º –¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö —Ä–µ–ø
    url = r.url
    if token and url.startswith("https://github.com/"):
        url = url.replace("https://", f"https://{token}@", 1)

    if not path.exists():
        code, out = _runcmd(f"git clone --depth=1 --branch {r.branch} {shlex.quote(url)} {shlex.quote(str(path))}")
    else:
        code, out = _runcmd("git fetch --all", cwd=path)
        if code==0:
            code, out2 = _runcmd(f"git reset --hard origin/{r.branch}", cwd=path)
            out += "\n" + out2
    if code==0:
        r.last_synced_at = dt.datetime.utcnow()
    await st.flush()
    return out
```

**UI: `app/handlers/repo.py`** (–Ω–æ–≤—ã–π)

```python
from __future__ import annotations
from aiogram import Router, F
from aiogram.types import CallbackQuery, InlineKeyboardMarkup, InlineKeyboardButton, ForceReply, Message
from app.db import session_scope
from app.repo import repo_add, repo_list, repo_sync, repo_remove
from app.config import settings

router = Router()

def repo_menu_kb():
    return InlineKeyboardMarkup(inline_keyboard=[[
        InlineKeyboardButton(text="‚ûï Add", callback_data="repo:add"),
        InlineKeyboardButton(text="üìú List", callback_data="repo:list"),
    ]])

@router.callback_query(F.data == "repo:open")
async def repo_open(cb: CallbackQuery):
    await cb.message.answer("Repo:", reply_markup=repo_menu_kb()); await cb.answer()

@router.callback_query(F.data == "repo:add")
async def repo_add_start(cb: CallbackQuery):
    await cb.message.answer("–§–æ—Ä–º–∞—Ç: <alias> <url> [branch]\n–ü—Ä–∏–º–µ—Ä: lovender https://github.com/user/repo main",
                            reply_markup=ForceReply(selective=True))
    await cb.answer()

@router.message(F.reply_to_message & F.reply_to_message.text.startswith("–§–æ—Ä–º–∞—Ç:"))
async def repo_add_reply(message: Message):
    parts = (message.text or "").splitlines()[-1].split()
    if len(parts) < 2:
        return await message.answer("–ù—É–∂–Ω–æ: <alias> <url> [branch]")
    alias, url, *rest = parts
    branch = rest[0] if rest else "main"
    async with session_scope() as st:
        await repo_add(st, message.from_user.id, alias, url, branch); await st.commit()
    await message.answer(f"–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–æ–±–∞–≤–ª–µ–Ω: {alias} ({branch})")

@router.callback_query(F.data == "repo:list")
async def repo_list_open(cb: CallbackQuery):
    async with session_scope() as st:
        items = await repo_list(st, cb.from_user.id)
    if not items:
        return await cb.message.answer("–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç. –ù–∞–∂–º–∏ ‚ûï Add.")
    rows = []
    for r in items:
        rows.append([
            InlineKeyboardButton(text=f"{r.alias} ({r.branch})", callback_data="noop"),
            InlineKeyboardButton(text="Sync", callback_data=f"repo:sync:{r.alias}"),
            InlineKeyboardButton(text="Remove", callback_data=f"repo:rm:{r.alias}"),
        ])
    await cb.message.answer("–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏:", reply_markup=InlineKeyboardMarkup(inline_keyboard=rows))
    await cb.answer()

@router.callback_query(F.data.startswith("repo:sync:"))
async def repo_sync_cb(cb: CallbackQuery):
    alias = cb.data.split(":")[-1]
    token = settings.github_token if hasattr(settings, "github_token") else None
    async with session_scope() as st:
        out = await repo_sync(st, cb.from_user.id, alias, token=token); await st.commit()
    await cb.message.answer(f"<code>{out[:3500]}</code>")
    await cb.answer()

@router.callback_query(F.data.startswith("repo:rm:"))
async def repo_rm_cb(cb: CallbackQuery):
    alias = cb.data.split(":")[-1]
    async with session_scope() as st:
        await repo_remove(st, cb.from_user.id, alias); await st.commit()
    await cb.message.answer(f"–£–¥–∞–ª—ë–Ω: {alias}"); await cb.answer()
```

---

# 6) –ú–µ–Ω—é Actions: –¥–æ–±–∞–≤–∏–º Export / Repo / Cleanup

**`app/handlers/menu.py`** ‚Äî –≤ –ø–æ—Å—Ç—Ä–æ–∏—Ç–µ–ª—å –º–µ–Ω—é –¥–æ–±–∞–≤—å 2 —Ä—è–¥–∫–∞:

```diff
 rows = [
   [InlineKeyboardButton(text="üìä –°—Ç–∞—Ç—É—Å", callback_data="status:show"),
    InlineKeyboardButton(text="üßπ –°–±—Ä–æ—Å —Ñ–∏–ª—å—Ç—Ä–æ–≤", callback_data="ctx:reset")],
   [InlineKeyboardButton(text="üìÑ –ò–º–ø–æ—Ä—Ç (–ø–æ—Å–ª–µ–¥–Ω–∏–π —Ñ–∞–π–ª)", callback_data="wizard:import"),
    InlineKeyboardButton(text="üóúÔ∏è –ò–º–ø–æ—Ä—Ç ZIP ‚Äî –ø–æ–¥—Å–∫–∞–∑–∫–∞", callback_data="hint:importzip")],
   [InlineKeyboardButton(text="üìö Sources", callback_data="sources:toggle"),
    InlineKeyboardButton(text="üéØ Scope", callback_data="scope:toggle"),
    InlineKeyboardButton(text="ü§´ Quiet", callback_data="quiet:toggle")],
   [InlineKeyboardButton(text="üìÇ Projects", callback_data="projects:list")],
+  [InlineKeyboardButton(text="üì§ Export", callback_data="export:open"),
+   InlineKeyboardButton(text="üîó Repo", callback_data="repo:open")],
+  [InlineKeyboardButton(text="üßπ Cleanup by date", callback_data="cleanup:open")],
 ]
```

–ò **–ø–æ–¥–∫–ª—é—á–∏ –Ω–æ–≤—ã–µ —Ä–æ—É—Ç–µ—Ä—ã**:

**`app/handlers/__init__.py`**

```diff
 from .export import router as export_router
 from .repo import router as repo_router
 from .cleanup import router as cleanup_router
 router.include_router(export_router)
 router.include_router(repo_router)
 router.include_router(cleanup_router)
```

---

# 7) Projects ‚Äî –∫–æ–º–ø–∞–∫—Ç–Ω–æ + –ø–∞–≥–∏–Ω–∞—Ü–∏—è (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

–ï—Å–ª–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤ –º–Ω–æ–≥–æ ‚Äî –≤–µ—Ä–Ω–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏—é (–ø–æ 8 –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É), –∫–∞–∫ –º—ã –¥–µ–ª–∞–ª–∏ —Ä–∞–Ω—å—à–µ. –ò–Ω–∞—á–µ —Ç–µ–∫—É—â–∏–π —Å–ø–∏—Å–æ–∫ —É–∂–µ –≥–æ–¥–µ–Ω.

---

# 8) –ü—Ä–µ—Å–µ—Ç—ã —Ç–µ–≥–æ–≤ (+ —Å–≤–æ–±–æ–¥–Ω—ã–π –≤–≤–æ–¥)

**–ú–∏–≥—Ä–∞—Ü–∏—è** `alembic/versions/0006_tag_presets.py`

```python
from alembic import op
import sqlalchemy as sa

revision = "0006_tag_presets"
down_revision = "0005_repos"

def upgrade():
    op.create_table("tag_presets",
        sa.Column("id", sa.Integer(), primary_key=True),
        sa.Column("user_id", sa.BigInteger(), nullable=False),
        sa.Column("project_id", sa.Integer(), nullable=True),
        sa.Column("tag", sa.String(64), nullable=False),
    )
    op.create_index("ix_tag_presets_user_proj", "tag_presets", ["user_id", "project_id"])

def downgrade():
    op.drop_index("ix_tag_presets_user_proj", table_name="tag_presets")
    op.drop_table("tag_presets")
```

**`app/services/tags.py`** (–Ω–æ–≤—ã–π)

```python
from __future__ import annotations
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, delete, insert
from app.models import Project
from sqlalchemy import Table, Column, Integer, BigInteger, String, ForeignKey, MetaData

# –±—ã—Å—Ç—Ä–∞—è —Ç–∞–±–ª–∏—á–∫–∞ —á–µ—Ä–µ–∑ Core (–∏–ª–∏ –¥–æ–±–∞–≤—å ORM-–º–æ–¥–µ–ª—å)
metadata = MetaData()
tag_presets = Table(
    "tag_presets", metadata,
    Column("id", Integer, primary_key=True),
    Column("user_id", BigInteger, nullable=False),
    Column("project_id", Integer, nullable=True),
    Column("tag", String(64), nullable=False),
)

DEFAULT_PRESETS = ["api","db","infra","matching","ui","auth","spec","plan","answer","summary","pinned","release-notes"]

async def get_presets(st: AsyncSession, user_id: int, project_id: int | None):
    res = await st.execute(select(tag_presets.c.tag).where(tag_presets.c.user_id==user_id, tag_presets.c.project_id==project_id))
    tags = [r[0] for r in res.fetchall()]
    return tags or DEFAULT_PRESETS

async def add_preset(st: AsyncSession, user_id: int, project_id: int | None, tag: str):
    await st.execute(insert(tag_presets).values(user_id=user_id, project_id=project_id, tag=tag.strip().lower()))

async def clear_presets(st: AsyncSession, user_id: int, project_id: int | None):
    await st.execute(delete(tag_presets).where(tag_presets.c.user_id==user_id, tag_presets.c.project_id==project_id))
```

**–í `app/handlers/answer_actions.py`** –∑–∞–º–µ–Ω–∏–º Tag-UX: —Å–Ω–∞—á–∞–ª–∞ –ø–æ–∫–∞–∂–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –ø—Ä–µ—Å–µ—Ç–æ–≤ (toggle), –∑–∞—Ç–µ–º ¬´–ì–æ—Ç–æ–≤–æ¬ª + ¬´–°–≤–æ–∏¬ª:

```python
# –≤–≤–µ—Ä—Ö—É:
from app.services.tags import get_presets

def build_tag_kb(tags: list[str], msg_id: int):
    # 3 –≤ —Ä—è–¥, –ø–ª—é—Å Done / Free input
    rows, row = [], []
    for i,t in enumerate(tags,1):
        row.append(InlineKeyboardButton(text=t, callback_data=f"ans:tagtoggle:{msg_id}:{t}"))
        if i%3==0: rows.append(row); row=[]
    if row: rows.append(row)
    rows.append([InlineKeyboardButton(text="‚úÖ –ì–æ—Ç–æ–≤–æ", callback_data=f"ans:tagdone:{msg_id}"),
                 InlineKeyboardButton(text="‚úçÔ∏è –°–≤–æ–∏", callback_data=f"ans:tagfree:{msg_id}")])
    return InlineKeyboardMarkup(inline_keyboard=rows)

# —Ç–µ–∫—É—â–µ–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –º–Ω–æ–∂–µ—Å—Ç–≤–æ –¥–µ—Ä–∂–∏–º –≤ –ø–∞–º—è—Ç–∏ –Ω–∞ 2 –º–∏–Ω—É—Ç—ã (–ø—Ä–æ—Å—Ç–∞—è –º–∞–ø–∞)
TAG_CACHE: dict[int, set[str]] = {}

@router.callback_query(F.data.startswith("ans:tag:"))
async def ans_tag(cb: CallbackQuery):
    msg_id = int(cb.data.split(":")[-1])
    async with session_scope() as st:
        # project-specific –ø—Ä–µ—Å–µ—Ç—ã
        bm = (await st.execute(sa.select(BotMessage).where(BotMessage.tg_message_id==msg_id))).scalars().first()
        pid = bm.project_id if bm else None
        presets = await get_presets(st, cb.from_user.id, pid)
    TAG_CACHE[msg_id] = set()
    await cb.message.answer("–í—ã–±–µ—Ä–∏ —Ç–µ–≥–∏ (—Ç–∞–ø –ø–æ –∫–Ω–æ–ø–∫–∞–º), –ø–æ—Ç–æ–º –Ω–∞–∂–º–∏ ¬´–ì–æ—Ç–æ–≤–æ¬ª.",
                            reply_markup=build_tag_kb(presets, msg_id))
    await cb.answer()

@router.callback_query(F.data.startswith("ans:tagtoggle:"))
async def ans_tag_toggle(cb: CallbackQuery):
    _, _, msg_id, tag = cb.data.split(":")
    msg_id = int(msg_id)
    cur = TAG_CACHE.get(msg_id, set())
    if tag in cur: cur.remove(tag)
    else: cur.add(tag)
    TAG_CACHE[msg_id] = cur
    await cb.answer(f"{'+' if tag in cur else '-'} {tag}")

@router.callback_query(F.data.startswith("ans:tagdone:"))
async def ans_tag_done(cb: CallbackQuery):
    msg_id = int(cb.data.split(":")[-1])
    tags = sorted(TAG_CACHE.get(msg_id, set()))
    if not tags:
        return await cb.answer("–ù–µ –≤—ã–±—Ä–∞–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ —Ç–µ–≥–∞.", show_alert=True)
    # –ø—Ä–∏–º–µ–Ω–∏–º –∫–∞–∫ —Ä–∞–Ω—å—à–µ, —Ç–æ–ª—å–∫–æ –±–µ–∑ ForceReply
    async with session_scope() as st:
        bm = (await st.execute(sa.select(BotMessage).where(BotMessage.tg_message_id==msg_id))).scalars().first()
        if not bm: return await cb.answer("Not found", show_alert=True)
        text = cb.message.text or cb.message.caption or ""
        target_pid = bm.project_id
        if not bm.saved or not bm.artifact_id:
            if not target_pid:
                return await cb.message.answer("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –ø—Ä–æ–µ–∫—Ç –≤ Actions ‚Üí Projects.")
            base = Artifact(project_id=target_pid, kind="answer", title="Chat answer", raw_text=text, pinned=False)
            st.add(base); await st.flush()
            bm.artifact_id = base.id; bm.saved = True; st.add(bm)
        await st.execute(sa.delete(artifact_tags).where(artifact_tags.c.artifact_id == bm.artifact_id))
        await st.execute(sa.insert(artifact_tags), [{"artifact_id": bm.artifact_id, "tag": t} for t in tags])
        await st.commit()
    await cb.message.answer(f"üè∑ –¢–µ–≥–∏: {', '.join(tags)}")
    TAG_CACHE.pop(msg_id, None)
    await cb.answer()

@router.callback_query(F.data.startswith("ans:tagfree:"))
async def ans_tag_free(cb: CallbackQuery):
    msg_id = int(cb.data.split(":")[-1])
    await cb.message.answer("–°–≤–æ–∏ —Ç–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):", reply_markup=ForceReply(selective=True))
    await cb.answer()

@router.message(F.reply_to_message & F.reply_to_message.text.startswith("–°–≤–æ–∏ —Ç–µ–≥–∏"))
async def tags_free_reply(message: Message):
    tags = [t.strip() for t in (message.text or "").split(",") if t.strip()]
    if not tags: return await message.answer("–ü—É—Å—Ç–æ.")
    # –ü—Ä–∏–º–µ–Ω–∏–º –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É BotMessage –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É –∫–æ–¥—É
    async with session_scope() as st:
        bm = (await st.execute(sa.select(BotMessage).where(BotMessage.user_id==message.from_user.id)
              .order_by(BotMessage.created_at.desc()).limit(1))).scalars().first()
        if not bm: return await message.answer("–ù–µ –Ω–∞—à—ë–ª —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ç–µ–≥–æ–≤.")
        text = message.reply_to_message and (message.reply_to_message.text or "") or ""
        target_pid = bm.project_id
        if not bm.saved or not bm.artifact_id:
            if not target_pid: return await message.answer("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –ø—Ä–æ–µ–∫—Ç.")
            base = Artifact(project_id=target_pid, kind="answer", title="Chat answer", raw_text=text, pinned=False)
            st.add(base); await st.flush()
            bm.artifact_id = base.id; bm.saved = True; st.add(bm)
        await st.execute(sa.delete(artifact_tags).where(artifact_tags.c.artifact_id == bm.artifact_id))
        await st.execute(sa.insert(artifact_tags), [{"artifact_id": bm.artifact_id, "tag": t} for t in tags])
        await st.commit()
    await message.answer(f"üè∑ –¢–µ–≥–∏: {', '.join(tags)}")
```

> –ü–æ–∑–∂–µ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å ¬´/tags preset Lovender: ‚Ä¶¬ª, —á—Ç–æ–±—ã –∑–∞—Ä–∞–Ω–µ–µ –∑–∞–±–∏—Ç—å –ø—Ä–µ—Å–µ—Ç—ã –Ω–∞ –ø—Ä–æ–µ–∫—Ç ‚Äî –±–∞–∑–∞ —É–∂–µ –µ—Å—Ç—å.

---

# 9) Scope-–ø–ª–∞—à–∫–∞ ‚Äî —É–∂–µ –¥–æ–±–∞–≤–∏–ª–∏ –≤ –ø—Ä–æ—à–ª–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏ (–∫–Ω–æ–ø–∫–∏ `auto / project / global`).

---

## –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å (—á–µ–∫-–ª–∏—Å—Ç)

1. `docker compose run --rm bot alembic upgrade head` ‚Üí –ø—Ä–∏–º–µ–Ω—è—Ç—Å—è `0005_repos` –∏ `0006_tag_presets`.
2. `linkbot-reset.ps1 -Rebuild` (–∏–ª–∏ –ø—Ä–æ—Å—Ç–æ `linkbot`).
3. **Actions**:

   * **üì§ Export** ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–µ–∫—Ç –≤ –∫–Ω–æ–ø–∫–µ, —ç–∫—Å–ø–æ—Ä—Ç–∏—Ç zip.
   * **üîó Repo** ‚Üí Add/List/Sync/Remove —Ä–∞–±–æ—Ç–∞—é—Ç; Sync –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ª–æ–≥ `git`.
   * **üßπ Cleanup by date** ‚Üí –≤–≤–æ–¥–∏—à—å `2025-09-13`, —É–¥–∞–ª—è–µ—Ç –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã —Å —ç—Ç–æ–π –¥–∞—Ç—ã –∏ –Ω–æ–≤–µ–µ (–≤ –∞–∫—Ç–∏–≤–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ).
4. –ò–º–ø–æ—Ä—Ç txt/zip ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è —Ç–µ–≥ `rel-YYYY-MM-DD`; .pmignore —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –º—É—Å–æ—Ä.
5. **Tags** ‚Üí ¬´üè∑ Tag¬ª –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø–ª–∞—à–∫—É –ø—Ä–µ—Å–µ—Ç–æ–≤; –º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å/—Å–Ω—è—Ç—å ‚Üí ¬´–ì–æ—Ç–æ–≤–æ¬ª –ø—Ä–∏–º–µ–Ω—è–µ—Ç. ¬´‚úçÔ∏è –°–≤–æ–∏¬ª ‚Äî —Ä—É—á–Ω–æ–π –≤–≤–æ–¥.
