## –ß—Ç–æ –∏–º–µ–Ω–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ (–ø–æ —Å—É—Ç–∏)

1. **–ù–∏ –æ–¥–Ω–∞ –∫–Ω–æ–ø–∫–∞ ASK –±–æ–ª—å—à–µ –Ω–µ —à–ª—ë—Ç –∑–∞–ø—Ä–æ—Å –∫ LLM.**
   –í—Å–µ `ask:*`-–∫–æ–ª–±—ç–∫–∏ —Ç–µ–ø–µ—Ä—å —Ç–æ–ª—å–∫–æ —Ä–∏—Å—É—é—Ç –ø–∞–Ω–µ–ª—å/—Å–ø–∏—Å–æ–∫, –ø–µ—Ä–µ–∫–ª—é—á–∞—é—Ç –≤—ã–±–æ—Ä –∏ —Å—Ç–∞–≤—è—Ç ¬´arm¬ª. LLM –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –û–î–ò–ù —Ä–∞–∑ ‚Äî —Ç–æ–ª—å–∫–æ –∏–∑ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞, –∫–æ–≥–¥–∞:

   * –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ¬´–≤–æ–æ—Ä—É–∂–∏–ª¬ª ASK (**üîé Ask**) –∏
   * **Chat: ON** –∏
   * –ø—Ä–∏—Å–ª–∞–ª –≤–æ–ø—Ä–æ—Å.

2. **Chat: OFF = –∞–±—Å–æ–ª—é—Ç–Ω—ã–π —Å—Ç–æ–ø LLM.**
   –í `chat.py` –¥–æ–±–∞–≤–ª–µ–Ω –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—Ö–æ–¥ –Ω–∞ LLM: free-text-—Ö–µ–Ω–¥–ª–µ—Ä. –û–Ω –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:

   * –µ—Å–ª–∏ `ask_armed=True` –∏ **Chat: OFF** ‚Üí –ø–æ–¥—Å–∫–∞–∑–∫–∞ ¬´–≤–∫–ª—é—á–∏ —á–∞—Ç¬ª –∏ **–Ω–∏–∫–∞–∫–æ–≥–æ** LLM; –∞—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è;
   * –µ—Å–ª–∏ `ask_armed=True` –∏ **Chat: ON** ‚Üí –≤—ã–∑—ã–≤–∞–µ–º `run_question_with_selection(...)` (–∫–æ–Ω—Ç–µ–∫—Å—Ç —Å—Ç—Ä–æ–∏–º —Å—Ç—Ä–æ–≥–æ –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤);
   * –µ—Å–ª–∏ `ask_armed=False` –∏ **Chat: ON** ‚Üí –≥–ª–æ–±–∞–ª—å–Ω—ã–π —á–∞—Ç (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø—É—Ç—å –±–µ–∑ ¬´–ª–µ–≤—ã—Ö¬ª –∫–æ–ª–±—ç–∫–æ–≤);
   * –µ—Å–ª–∏ **Chat: OFF** ‚Üí –Ω–∏—á–µ–≥–æ –Ω–µ —à–ª—ë–º –≤ –º–æ–¥–µ–ª—å.

3. **–§–∏–ª—å—Ç—Ä —Å–ª—É–∂–µ–±–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤.**
   –í `chat.py` –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è –≤—Å–µ —Å–µ—Ä–≤–∏—Å–Ω—ã–µ –Ω–∞–∂–∞—Ç–∏—è (`‚öôÔ∏è Actions`, `Ask ‚ùì`, `üí¨ Chat: ON`, `üò¥ Chat: OFF`, `–ú–µ–Ω—é`, `Menu`, `Chat`).
   –≠—Ç–æ —Ä—É–±–∏—Ç –∫–µ–π—Å, –∫–æ–≥–¥–∞ –Ω–∞–∂–∞—Ç–∞—è –∫–Ω–æ–ø–∫–∞ —Å–ª—É—á–∞–π–Ω–æ —É–ª–µ—Ç–∞–ª–∞ –≤ free-text.

4. **–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å–Ω–∏–∑—É —Å—Ç—Ä–æ–≥–æ –≤ –æ–¥–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ**
   `‚öôÔ∏è Actions | üí¨/üò¥ Chat: ON/OFF | Ask ‚ùì` ‚Äî —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –∫–∞–∫ `main_reply_kb(chat_on: bool)`.
   –•–µ–Ω–¥–ª–µ—Ä –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —á–∞—Ç–∞ **–Ω–µ** —Ç—Ä–æ–≥–∞–µ—Ç LLM, —Ç–æ–ª—å–∫–æ flip-—Ñ–ª–∞–≥ –∏ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã.

5. **ASK-wizard –ø–æ —Å—Ö–µ–º–µ**

   * `Ask ‚ùì` ‚Üí –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø–∞–Ω–µ–ª—å (–±–µ–∑ –≤—ã–∑–æ–≤–∞ –º–æ–¥–µ–ª–∏): `üîç –ü–æ–∏—Å–∫` ‚Ä¢ `üîé Ask` ‚Ä¢ `Auto-clear: ON/OFF` ‚Ä¢ `‚ùå –°–±—Ä–æ—Å` ‚Ä¢ –ª–µ–π–±–ª **¬´–ë—é–¥–∂–µ—Ç: \~N —Ç–æ–∫–µ–Ω–æ–≤¬ª**.
   * `üîç –ü–æ–∏—Å–∫` ‚Üí `ForceReply("–í–≤–µ–¥–∏—Ç–µ —á–∞—Å—Ç—å –∏–º–µ–Ω–∏‚Ä¶")`.
   * –û—Ç–≤–µ—Ç –Ω–∞ ForceReply ‚Üí —Å–ø–∏—Å–æ–∫ —Å –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è–º–∏ `‚ûï/üß∫` (–ø–µ—Ä—Å–∏—Å—Ç –≤ `user_state.selected_artifact_ids`).
   * `üîé Ask` ‚Üí –µ—Å–ª–∏ –Ω–µ—Ç –≤—ã–±–æ—Ä–∞ ‚Äî –∞–ª–µ—Ä—Ç; –∏–Ω–∞—á–µ `ask_armed=True`.

     * –ü—Ä–∏ **Chat: OFF** ‚Üí –ø–æ–¥—Å–∫–∞–∑–∫–∞ ¬´–≤–∫–ª—é—á–∏ —á–∞—Ç¬ª + ForceReply –≤–æ–ø—Ä–æ—Å–∞ (–±–µ–∑ –º–æ–¥–µ–ª–∏);
     * –ü—Ä–∏ **Chat: ON** ‚Üí ForceReply –≤–æ–ø—Ä–æ—Å–∞ (–±–µ–∑ –º–æ–¥–µ–ª–∏).
   * –¢–æ–ª—å–∫–æ –Ω–∞ **—Å–ª–µ–¥—É—é—â–∏–π free-text** (–≤–æ–ø—Ä–æ—Å) –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç 1 –≤—ã–∑–æ–≤ LLM, –∫–Ω–æ–ø–∫–∏ –æ—Ç–≤–µ—Ç–∞ = `üíæ Save ‚Ä¢ üß∑ Summary ‚Ä¢ üè∑ Tag ‚Ä¢ üóë Delete ‚Ä¢ üîÅ Refine`.
   * –ü—Ä–∏ `Auto-clear: ON` ‚Äî –∫–æ—Ä–∑–∏–Ω–∞ –≤—ã–±–æ—Ä–∞ –æ—á–∏—â–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞.

6. **–ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ –≤—ã–±–æ—Ä—É**
   –í `ask.py` –¥–æ–±–∞–≤–ª–µ–Ω `run_question_with_selection(...)`: —Ç—è–Ω–µ–º `Chunk` –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö `artifact_id`, —Å–æ–±–∏—Ä–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–æ –ª–∏–º–∏—Ç–∞, –≤—ã–∑—ã–≤–∞–µ–º `ask_llm(...)`, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º `ask_armed` –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ ‚Äî –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ –≤—ã–±–æ—Ä–∞.
> ‚öôÔ∏è –ù–∏–∫–∞–∫–∏—Ö –ø—Ä–∞–≤–æ–∫ `.env` –∏ `docker-compose.yml` ‚Äî –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.

–ï—Å–ª–∏ –≤–¥—Ä—É–≥ –≤ —Ç–≤–æ–µ–π –ë–î **–Ω–µ—Ç** `user_state.ask_armed` (—É —Ç–µ–±—è, —Å—É–¥—è –ø–æ –º–æ–¥–µ–ª–∏, –µ—Å—Ç—å), –≤–æ—Ç –º–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ –≤—Å—è–∫–∏–π:

```py
op.add_column("user_state", sa.Column("ask_armed", sa.Boolean(), server_default=sa.text("false"), nullable=False))
```

---

## –ß–µ–∫-–ª–∏—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ (–∫–æ—Ä–æ—Ç–∫–æ)

1. –ù–∏–∂–Ω—è—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ ‚Äî —Ä–æ–≤–Ω–æ: **‚öôÔ∏è Actions | üí¨/üò¥ Chat: ON/OFF | Ask ‚ùì**.
2. –ù–∞–∂–∞–ª **Ask ‚ùì** ‚Üí –ø–æ—è–≤–∏–ª–∞—Å—å –ø–∞–Ω–µ–ª—å; **–Ω–∏–∫–∞–∫–æ–π** –≤—ã–∑–æ–≤ –º–æ–¥–µ–ª–∏.
3. **üîç –ü–æ–∏—Å–∫** ‚Üí ForceReply; –æ—Ç–ø—Ä–∞–≤–ª—è–µ—à—å ¬´code¬ª ‚Üí –≤–∏–¥–∏—à—å —Å–ø–∏—Å–æ–∫; `‚ûï/üß∫` —Ä–∞–±–æ—Ç–∞–µ—Ç; **–ë—é–¥–∂–µ—Ç** –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è.
4. **üîé Ask**:

   * –ø—Ä–∏ **Chat: OFF** ‚Üí –ø–æ–¥—Å–∫–∞–∑–∫–∞ –≤–∫–ª—é—á–∏—Ç—å —á–∞—Ç + ForceReply; **–º–æ–¥–µ–ª—å –Ω–µ –∑–æ–≤—ë—Ç—Å—è**;
   * –ø—Ä–∏ **Chat: ON** ‚Üí ForceReply ¬´–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å‚Ä¶¬ª; **–º–æ–¥–µ–ª—å –Ω–µ –∑–æ–≤—ë—Ç—Å—è**.
5. –ü–∏—à–µ—à—å –≤–æ–ø—Ä–æ—Å ‚Üí –æ–¥–∏–Ω –æ—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏ + **5 –∫–Ω–æ–ø–æ–∫** (Save/Summary/Tag/Delete/Refine).
6. `Auto-clear: ON` ‚Üí –≤—ã–±–æ—Ä –æ—á–∏—â–∞–µ—Ç—Å—è; `OFF` ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è.
7. –õ—é–±–∞—è –∫–Ω–æ–ø–∫–∞ –∏–∑ ASK **–Ω–∏–∫–æ–≥–¥–∞** –Ω–µ —à–ª—ë—Ç LLM —Å–∞–º–∞ –ø–æ —Å–µ–±–µ.
8. –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–∞–Ω–µ–ª–µ–π –Ω–µ –æ—Å—Ç–∞–≤–ª—è–µ—Ç ¬´—Ö–≤–æ—Å—Ç–æ–≤¬ª.

---

## –ï—Å–ª–∏ –≤—Å—ë –µ—â—ë ¬´—É–ª–µ—Ç–∞–µ—Ç –≤ LLM¬ª

–ü—Ä–æ–≤–µ—Ä—å, –Ω–µ –æ—Å—Ç–∞–ª–∏—Å—å –ª–∏ –≥–¥–µ-—Ç–æ —Å–ª—É—á–∞–π–Ω—ã–µ –≤—ã–∑–æ–≤—ã –≤–Ω—É—Ç—Ä–∏ –∫–æ–ª–±—ç–∫–æ–≤:

```
rg -n "ask_llm|run_llm|generate_answer|call_openai" app/handlers
```

–í `ask.py` –∏ `keyboard.py` –∫–æ–ª–±—ç–∫–∏ –Ω–µ –¥–æ–ª–∂–Ω—ã –¥–µ—Ä–≥–∞—Ç—å LLM. –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ ‚Äî `on_free_text` –≤ `chat.py`.

