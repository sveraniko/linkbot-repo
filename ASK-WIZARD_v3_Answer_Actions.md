
# ASK‚ÄëWIZARD v3 ‚Äî Answer Actions (Save/Pin/Summary/Delete/Refine)

> –¶–µ–ª—å: –≤–µ—Ä–Ω—É—Ç—å ¬´–∫–Ω–æ–ø–∫–∏ –ø–æ–¥ –æ—Ç–≤–µ—Ç–æ–º LLM¬ª –±–µ–∑ –º—É—Å–æ—Ä–∞ –≤ —á–∞—Ç–µ –∏ —Å –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–º —Ö—Ä–∞–Ω–µ–Ω–∏–µ–º.
> –í—Å–µ –∫–æ–ª–±—ç–∫–∏ namespaced –∫–∞–∫ `ask:answer:*`. –ù–∏–∫–∞–∫–∏—Ö –Ω–æ–≤—ã—Ö ¬´‚Ä¶¬ª —Å–æ–æ–±—â–µ–Ω–∏–π ‚Äî —Ç–æ–ª—å–∫–æ –≤—Å–ø–ª—ã–≤–∞—à–∫–∏ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ.

---

## 0) –ì–¥–µ —Ä–∞–∑–º–µ—â–∞–µ–º –∫–Ω–æ–ø–∫–∏
- –ü–æ–¥ **–∏—Ç–æ–≥–æ–≤—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º –æ—Ç–≤–µ—Ç–∞ LLM** (—Ç–µ–º, —á—Ç–æ —Å–µ–π—á–∞—Å –ø—Ä–∏—Ö–æ–¥–∏—Ç) –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å **–æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É**:
  - `üíæ Save` ‚Ä¢ `üìå Pin` ‚Ä¢ `üßæ Summary` ‚Ä¢ `üóë Delete` ‚Ä¢ `üîÅ Refine` ‚Ä¢ `üìö Sources`
- –ö–Ω–æ–ø–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç **–±–µ–∑ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏** –≤—Å–µ–≥–æ –±–ª–æ–∫–∞, —Ç–æ–ª—å–∫–æ `edit_message_reply_markup` –∏ `answerCallbackQuery`.
- –í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è ‚Äî ¬´—á–∏—Å—Ç—ã–π —ç–∫—Ä–∞–Ω¬ª: –Ω–µ –ø–ª–æ–¥–∏–º –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –∫—Ä–æ–º–µ —Å–ª—É—á–∞–µ–≤, –æ–ø–∏—Å–∞–Ω–Ω—ã—Ö –Ω–∏–∂–µ.

**–ü—Ä–µ—Ñ–∏–∫—Å—ã callback-data:**
- `ask:answer:save:<run_id>`
- `ask:answer:pin:<answer_id|temp>`
- `ask:answer:summary:<answer_id|temp>`
- `ask:answer:delete:<answer_id|msg_id>`
- `ask:answer:refine:<run_id>`
- `ask:answer:sources:<run_id>`

`run_id` ‚Äî –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–æ–≤–µ—Ä—à—ë–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ (LLM‚Äë—Ä–∞–Ω), —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ —Å—Ç–µ–π—Ç–µ –æ—Ç–≤–µ—Ç–∞ –∏ –≤ –ë–î.

---

## 1) –ú–æ–¥–µ–ª—å —Ö—Ä–∞–Ω–µ–Ω–∏—è (–∫—É–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

**–ë–µ–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤/–ø–æ–¥–º–µ–Ω:** `üíæ Save` —Å–æ–∑–¥–∞—ë—Ç **–Ω–æ–≤—ã–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç** –≤ –∞–∫—Ç–∏–≤–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ.

- –¢–∞–±–ª–∏—Ü–∞/–º–æ–¥–µ–ª—å: —Ç–æ—Ç –∂–µ `Artifact` (–∫–∞–∫ –∏ –ø—Ä–æ—á–∏–µ –∑–∞–º–µ—Ç–∫–∏), `kind='answer'` (–∏–ª–∏ —Ç–µ–≥ `answer`).
- –ü–æ–ª—è:
  - `title`: `Answer ‚Äî <–ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –≤–æ–ø—Ä–æ—Å–∞> [<YYYY-MM-DD HH:MM>]`
  - `content_md`: **–ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞**, —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–ª—è MarkdownV2/HTML
  - `related_source_ids: jsonb` ‚Äî —Å–ø–∏—Å–æ–∫ `selected_artifact_ids` –∏–∑ —Ä–∞–Ω–∞
  - `run_meta: jsonb` ‚Äî `model`, `tokens_in/out`, `duration_ms`, `run_id`
  - `tags`: `["answer"]` (+ –ø—Ä–∏ –ø–∏–Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º `"pinned"`)
- –õ–∏–Ω–∫–∏ –∫ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º: –æ—Ç–¥–µ–ª—å–Ω–∞—è —Å–≤—è–∑–∫–∞ `answer_links(answer_id, source_id)` ‚Äî **–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ**, –Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ.

**–ü–æ—á–µ–º—É —Ç–∞–∫:** —ç—Ç–æ –Ω–µ ¬´–¥–æ–ø–∏—Å–∞—Ç—å –≤ –∏—Å—Ç–æ—á–Ω–∏–∫¬ª, –∞ –æ—Ç–¥–µ–ª—å–Ω–∞—è –∑–∞–ø–∏—Å—å —Å –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º–∏ —Å—Å—ã–ª–∫–∞–º–∏. –ù–∏—á–µ–≥–æ –Ω–µ –ø–µ—Ä–µ—Ç–∏—Ä–∞–º.

---

## 2) –ü–æ–≤–µ–¥–µ–Ω–∏–µ –∫–∞–∂–¥–æ–π –∫–Ω–æ–ø–∫–∏

### 2.1 `üíæ Save` ‚Üí `ask:answer:save:<run_id>`
- –ï—Å–ª–∏ –µ—â—ë **–Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ**:
  - —Å–æ–∑–¥–∞—Ç—å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç (—Å–º. ¬ß1);
  - –∑–∞–º–µ–Ω–∏—Ç—å `save` –Ω–∞ `‚úÖ Saved` (–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–Ω–æ–ø–∫–∞, –ª–∏–±–æ `üíæ Save` ‚Üí `üóÇ Open`, –Ω–∞ –≤–∞—à –≤—ã–±–æ—Ä);
  - `_toast("–û—Ç–≤–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω")`.
- –ï—Å–ª–∏ —É–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ ‚Äî `_toast("–£–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ")`.

### 2.2 `üìå Pin` ‚Üí `ask:answer:pin:<answer_id|temp>`
- –ï—Å–ª–∏ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ ‚Äî **—Å–Ω–∞—á–∞–ª–∞** –≤—ã–ø–æ–ª–Ω–∏—Ç—å `Save`, –∑–∞—Ç–µ–º —Ç—É–º–±–ª–µ—Ä `pinned`:
  - –¥–æ–±–∞–≤–∏—Ç—å/—É–±—Ä–∞—Ç—å —Ç–µ–≥ `pinned` —É —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞;
  - –ø–æ–º–µ–Ω—è—Ç—å –∏–∫–æ–Ω–∫—É –Ω–∞ `üìå Pinned`/`üìç Unpin` (–≤ —ç—Ç–æ–π –∂–µ —Å—Ç—Ä–æ–∫–µ);
  - `_toast("–ó–∞–∫—Ä–µ–ø–ª–µ–Ω–æ"/"–û—Ç–∫—Ä–µ–ø–ª–µ–Ω–æ")`.

### 2.3 `üßæ Summary` ‚Üí `ask:answer:summary:<answer_id|temp>`
- –°—É–º–º–∞—Ä–∏–∑–∏—Ä—É–µ–º **—Å–∞–º –æ—Ç–≤–µ—Ç** –¥–æ ~5‚Äì8 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π. –ú–æ–∂–Ω–æ LLM (–º–∞–ª—ã–π –±—é–¥–∂–µ—Ç) –∏–ª–∏ –ª–æ–∫–∞–ª—å–Ω—ã–π —ç–∫—Å—Ç—Ä–∞–∫—Ç–∏–≤ (–µ—Å–ª–∏ Chat: OFF ‚Äî –Ω–µ –≤—ã–∑—ã–≤–∞—Ç—å LLM).
- –†–µ–∑—É–ª—å—Ç–∞—Ç:
  - –µ—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ ‚Äî **–¥–æ–±–∞–≤–∏—Ç—å** –≤ –∫–æ–Ω–µ—Ü `content_md` –±–ª–æ–∫ `## Summary
‚Ä¶`;
  - –µ—Å–ª–∏ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ ‚Äî —Å–Ω–∞—á–∞–ª–∞ `Save`, –∑–∞—Ç–µ–º –¥–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫;
  - `_toast("–°–≤–æ–¥–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞")`.

### 2.4 `üóë Delete` ‚Üí `ask:answer:delete:<answer_id|msg_id>`
- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –≤—Å–ø–ª—ã–≤–∞—à–∫—É `show_alert=True` (–∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω–∞—è inline‚Äë–∫–Ω–æ–ø–∫–∞ ¬´–î–∞, —É–¥–∞–ª–∏—Ç—å¬ª –≤ —Ç–æ–π –∂–µ —Å—Ç—Ä–æ–∫–µ).
- –ï—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ ‚Äî –ø–æ–º–µ—Ç–∏—Ç—å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç –∫–∞–∫ —É–¥–∞–ª—ë–Ω–Ω—ã–π (–∏–ª–∏ —Ñ–∏–∑–∏—á–µ—Å–∫–∏ —É–¥–∞–ª–∏—Ç—å) –∏ `_toast("–£–¥–∞–ª–µ–Ω–æ")`.
- –£–¥–∞–ª–∏—Ç—å **—Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞** (`deleteMessage`). –ü—É—Å—Ç—ã—Ö —Å–ª–µ–¥–æ–≤ –Ω–µ –æ—Å—Ç–∞–≤–ª—è–µ–º.

### 2.5 `üîÅ Refine` ‚Üí `ask:answer:refine:<run_id>`
- –û—Ç–∫—Ä—ã—Ç—å ForceReply ¬´–ß–µ–º —É—Ç–æ—á–Ω–∏—Ç—å?¬ª; —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å `ask_prompt_msg_id`.
- –ü–æ—Å–ª–µ –≤–≤–æ–¥–∞: **—É–¥–∞–ª–∏—Ç—å** –ø—Ä–æ–º–ø—Ç –∏ –≤–≤–æ–¥, –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–æ–≤—ã–π —Ä–∞–Ω LLM **—Å —Ç–µ–º–∏ –∂–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏** –∏ `base_question + " / —É—Ç–æ—á–Ω–µ–Ω–∏–µ: ..."`.  
- –≠–∫—Ä–∞–Ω ¬´–ì–æ—Ç–æ–≤–ª—é –æ—Ç–≤–µ—Ç‚Ä¶¬ª ‚Üí —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –Ω–æ–≤—ã–π –æ—Ç–≤–µ—Ç (—Å —Ç–æ–π –∂–µ –ø–∞–Ω–µ–ª—å—é –∫–Ω–æ–ø–æ–∫).
- –ï—Å–ª–∏ Chat: OFF ‚Äî —Å–Ω–∞—á–∞–ª–∞ –ø–æ–∫–∞–∑–∞—Ç—å –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–æ–π ¬´–í–∫–ª—é—á–∏—Ç—å —á–∞—Ç¬ª, –∫–∞–∫ –≤ –±–∞–∑–æ–≤–æ–º —Å—Ü–µ–Ω–∞—Ä–∏–∏ Ask.

### 2.6 `üìö Sources` ‚Üí `ask:answer:sources:<run_id>`
- –í—Å–ø–ª—ã–≤–∞—à–∫–∞ —Å–æ —Å–ø–∏—Å–∫–æ–º id/–∫–æ—Ä–æ—Ç–∫–∏—Ö –Ω–∞–∑–≤–∞–Ω–∏–π –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤, –ª–∏–±–æ –Ω–µ–±–æ–ª—å—à–∞—è –∑–∞–º–µ–Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –Ω–∞ —Å–ø–∏—Å–æ–∫ ¬´–ø–ª–∞—à–µ–∫¬ª —Å–æ —Å—Å—ã–ª–∫–∞–º–∏ `Show` (–µ—Å–ª–∏ –≤ –ø—Ä–æ–µ–∫—Ç–µ —É–∂–µ –µ—Å—Ç—å —Ç–∞–∫–æ–π UX).
- –ì–ª–∞–≤–Ω–æ–µ: **–Ω–µ** –ø–ª–æ–¥–∏—Ç—å –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è; –ø–æ –∑–∞–∫—Ä—ã—Ç–∏—é –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –æ—Å–Ω–æ–≤–Ω–æ–π —Å—Ç—Ä–æ–∫–µ –∫–Ω–æ–ø–æ–∫.

---

## 3) –°—Ç–µ–π—Ç –∏ id
- –í –º–æ–º–µ–Ω—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ LLM —Å–æ—Ö—Ä–∞–Ω—è–µ–º `run_id` –∏ `used_source_ids` –≤ —Ç–∞–±–ª–∏—Ü—É —Ä–∞–Ω–æ–≤ –∏–ª–∏ –≤ `user_state.last_answer_run`.
- –ü—Ä–∏ `Save` —Å–æ–∑–¥–∞—ë–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç –∏ –¥–æ–∫–ª–∞–¥—ã–≤–∞–µ–º `answer_id` –≤ `run_meta` –∏ –≤ —Å—Ç–µ–π—Ç (–¥–ª—è Pin/Summary/Delete).
- –í—Å—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è **–Ω–∞ –º–µ—Å—Ç–µ** (`edit_message_reply_markup`).

---

## 4) –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ ¬´—á–∏—Å—Ç—ã–π —ç–∫—Ä–∞–Ω¬ª
- –õ—é–±—ã–µ —Å—Ç–∞—Ç—É—Å—ã ‚Äî –≤—Å–ø–ª—ã–≤–∞—à–∫–æ–π; ForceReply –∏ –æ—Ç–≤–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî —É–¥–∞–ª—è—Ç—å.
- –ù–∏ –æ–¥–Ω–æ–π –Ω–æ–≤–æ–π ¬´—Å–ª—É–∂–µ–±–Ω–æ–π¬ª –ø—Ä–æ—Å—Ç—ã–Ω–∏ —Å–æ–æ–±—â–µ–Ω–∏–π. ¬´Refine¬ª –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç —Ä–∞–Ω –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç **—Ç–µ–∫—É—â–µ–µ** —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞.
- `Summary`/`Pin`/`Save` –Ω–µ –¥–æ–ª–∂–Ω—ã –≤—ã–∑—ã–≤–∞—Ç—å LLM, –∫—Ä–æ–º–µ `Summary` (–¥–æ–ø—É—Å–∫–∞–µ–º –º–∞–ª—ã–π –±—é–¥–∂–µ—Ç –ø—Ä–∏ Chat: ON).
- –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ MarkdownV2/HTML ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞.

---

## 5) Acceptance (–º–∏–Ω–∏–º—É–º)
1) –ü–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ LLM –≤–∏–¥–∏–º —Å—Ç—Ä–æ–∫—É –∫–Ω–æ–ø–æ–∫ `üíæ Save ‚Ä¢ üìå Pin ‚Ä¢ üßæ Summary ‚Ä¢ üóë Delete ‚Ä¢ üîÅ Refine ‚Ä¢ üìö Sources`.
2) `Save` —Å–æ–∑–¥–∞—ë—Ç **–Ω–æ–≤—ã–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç** (kind/tag `answer`) –≤ –∞–∫—Ç–∏–≤–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –∏ –º–µ–Ω—è–µ—Ç –∫–Ω–æ–ø–∫—É –Ω–∞ `‚úÖ Saved`/`üóÇ Open`. –¢–µ–≥–∏ –∏ `run_meta` –∑–∞–ø–æ–ª–Ω–µ–Ω—ã. 
3) `Pin` ‚Äî —Ç—É–º–±–ª–µ—Ä: –¥–æ–±–∞–≤–ª—è–µ—Ç/—É–±–∏—Ä–∞–µ—Ç `pinned` (–∏–∫–æ–Ω–∫–∞ –º–µ–Ω—è–µ—Ç—Å—è —Å—Ä–∞–∑—É).
4) `Summary` ‚Äî –¥–æ–±–∞–≤–ª—è–µ—Ç –±–ª–æ–∫ –≤ –∫–æ–Ω–µ—Ü —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞, –Ω–µ —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.
5) `Delete` ‚Äî —É–¥–∞–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –∏ –ø–æ–º–µ—á–∞–µ—Ç –∞—Ä—Ç–µ—Ñ–∞–∫—Ç (–µ—Å–ª–∏ –±—ã–ª). –ù–∏–∫–∞–∫–∏—Ö ¬´—Ö–≤–æ—Å—Ç–æ–≤¬ª –≤ —á–∞—Ç–µ.
6) `Refine` ‚Äî ForceReply, —É–¥–∞–ª—è–µ–º –≤–≤–æ–¥, –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Ä–∞–Ω–∞ —Å —Ç–µ–º–∏ –∂–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ –Ω–æ–≤—ã–π –æ—Ç–≤–µ—Ç.
7) `Sources` ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ **–±–µ–∑** –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π/—Å–ø–∞–º–∞.
8) –õ–æ–≥–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç `run_id`, `answer_id`, `source_ids`, `tokens in/out`, `duration`; –æ—à–∏–±–æ–∫ –Ω–µ—Ç.
