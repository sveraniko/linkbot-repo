
# Конституция ботов (v2): Антихрупкость, UX, миграции, LLM, медиа

Этот документ — **единый стандарт** для всех наших ботов (Lovender, Linkbot и др.).
Его цель — чтобы _любая_ новая фича не ломала прод, а доработка одной кнопки не рушила остальное.

Документ **процессный и технологический**: здесь принципы, инварианты и чек‑листы. **Без кода.**

---

## 0) Базовые принципы

- **Антихрупкость:** изменение локально и обратимо; фича‑флаги; единственная точка интеграции с LLM; миграции линейны и проверяемы.
- **Чистый экран:** бот _всегда_ сообщает, что произошло; «мусор» подчищается; нижняя Reply‑клава всегда на виду.
- **Контракты между модулями:** неймспейсы callback’ов, константы UI, порядок роутеров, схема БД как договор.
- **Тестопригодность:** стоп‑кран LLM, smoke‑набор, линтеры, проверки миграций перед запуском.

---

## 1) UI/UX: «Чистый экран» как закон

**1.1 Нижняя Reply‑клавиатура (persistent)**  
- Обязательна «панель вкладок» (пример: Лента/Профиль) — `is_persistent = true`.  
- Показывать/удерживать панель единым «держателем» (единый контейнер‑сообщение).  
- Менять её _только_ функцией высокого уровня (чтобы не плодить копии).

**1.2 Inline‑клавиатуры — эфемерные**  
- Любая вложенная панель исчезает после выбора/шагов визарда.  
- После действия — либо редактируем **тот же контейнер** (edit), либо удаляем и шлём новое «чистое» сообщение.  
- Пользовательские ответы (значения форм, ForceReply) — **удаляем** мягко с задержкой.

**1.3 Коммуникация «как человек»**  
- Бот проговаривает: _что сделал / что ждёт / что дальше_ — в тексте или попапе (alert).  
- После каждого шага — видимый результат и короткая подсказка.

**1.4 Константы текстов и иконок**  
- Все подписи кнопок/панелей — через **константы** в одном модуле UI.  
- Менять тексты — только там. От прямых строк в хендлерах — отказаться.

---

## 2) Маршрутизация и приоритеты

**2.1 Порядок подключения роутеров (aiogram)**  
1) Клавиатура/Actions/Chat (нижние кнопки)  
2) Визарды/процессы (любой домен)  
3) Меню/панели (общие)  
4) **Последним** — catch‑all свободного текста

**2.2 Сервисные тексты**  
- Список служебных текстов (Actions, Chat ON/OFF, «назад», имена вкладок) — централизованная константа.  
- Catch‑all обязан **игнорировать** их.

**2.3 Неймспейсы callback’ов**  
- Каждому домену — свой префикс:  
  `wiz:*` (визарды), `mem:*` (память), `act:*` (actions), `cfg:*` (настройки), `imp:*` (импорт), …  
- Запрещено делить префиксы между доменами. Конфликты недопустимы.

---

## 3) Состояния, визарды, ForceReply

**3.1 FSM/состояния**  
- Любой визард обязан держать явные флаги: `awaiting_<step>`, `armed`, `auto_clear` и т.п.  
- Эти флаги хранятся в **user_state** (в БД или FSM) и сбрасываются после шага.

**3.2 ForceReply**  
- Ответ на ForceReply ловим **по флагу состояния**, а не по совпадению текста подсказки.  
- Пока флаг активен — catch‑all молчит.

**3.3 Чистка**  
- Ответ пользователя (ввод значения) удаляется «мягко» через расписание.  
- Вложенные панели (inline) закрываются после обработки. Экран не захламляется.

---

## 4) LLM: контракт и стоп‑кран

**4.1 Единственная точка вызова LLM**  
- Никакие кнопки, визард‑шаги, переключатели — **не** обращаются к LLM.  
- Вызов модели — только из _одной_ функции обработки свободного текста в «вооружённом» состоянии.

**4.2 Стоп‑кран (dry‑run)**  
- `LLM_DISABLED=1` (по умолчанию в dev/stage) → любые попытки запроса возвращают stub‑ответ и метаданные (без токенов).  
- На проде включается осознанно.  
- Метрики: счётчик обращений, токены, латентность.

**4.3 Экранирование и безопасный промптинг**  
- Любой пользовательский текст экранируем (HTML/Markdown/Prompt).  
- Промпты параметризованы (templates), токен‑лимиты и приоритеты заданы.

---

## 5) Миграции (Alembic) без боли

**5.1 Стандарты**  
- Никаких правок старых миграций. Новая фича — новая миграция.  
- Имена миграций: `YYYYMMDD_HHMM_slug.py`, ревизия = имя файла.  
- Параллельные ветки → `merge`‑миграции; `down_revision` строгий.

**5.2 Жизненный цикл**  
- Перед запуском — `alembic upgrade head`; если ревизия не head → **не стартовать**, явная ошибка.  
- Новое поле в коде не читаем до миграции (фича‑флаг или fallback).  
- Новые поля: `NOT NULL DEFAULT` + серверный default, чтобы старые записи не падали.

**5.3 Откаты и сиды**  
- Каждая миграция с `downgrade`.  
- Сид‑данные — отдельные утилиты/скрипты, не в миграциях.

---

## 6) Идентификаторы, даты, теги

**6.1 Public ID**  
- Внешние/человеческие идентификаторы — **ULID/KSUID** или шаблон `AAA-YYYYMMDD-NNNN` (лексикографическая сортировка по времени).  
- Храним и numeric `id`, и `public_id` (уникальный индекс).

**6.2 Теги**  
- Формат: `kebab-case`, ASCII, максимум 32 символа.  
- Резервные системные теги: `sys:*` (нельзя редактировать руками).

**6.3 Даты/время**  
- В базе — **UTC**. На уровне UX — локализация пользователя (часовой пояс, язык).  
- Все внешние даты — ISO‑8601. В логике — только `datetime` с таймзоной.

**6.4 Импорт/нумерация**  
- Любая импортная сущность получает стабильный `public_id` + метки источника (source, batch, checksum).  
- Повторный импорт одинакового файла определяется по хешу/size+ts, чтобы не плодить дубликаты.

---

## 7) Импорт и медиа

**7.1 Транспорт**  
- Получение файлов **по `file_id`**; связка `get_file → file_path` — запрещена для прод.  
- В хранилище (S3/локально) — `bucket/key` + метаданные: `mime`, `size`, `duration`, `width/height`, `hash`.

**7.2 Асинхронка**  
- Тяжёлые операции (превью, транскрипция, модерация) — фоновые задачи с ретраями, лимитами и айдём‑корреляции.

**7.3 Доступ/приватность**  
- Сопоставление медиа с владельцем (`user_id`), проверка доступа.  
- Публичные ссылки — только временные (pre‑signed).

---

## 8) Безопасность

- Секреты — только из `.env`/vault.  
- Инпуты валидируем, HTML/Markdown экранируем, SQL только на бинде ORM.  
- Анти‑архив‑бомба, лимиты размеров, защита от спама/флуда.

---

## 9) Логи, метрики, инциденты

- Логи структурные (json): `request_id`, пользователь, действие, результат, длительность, ошибки.  
- Метрики: аптайм, ошибки по типам, токены LLM, время отклика, очереди задач.  
- Алерты на падения ключевых потоков (импорт, визарды, LLM).  
- Инцидент‑плейбук: как выключить фичу флагом, как сделать roll‑back миграции.

---

## 10) CI/CD и статические проверки

**10.1 Pre‑commit**  
- Форматирование/линтер/типизация.  
- `grep`‑запреты: вызовы LLM в колбэках, мутация Telegram‑моделей, «магические строки» UI.  
- Проверка, что новые callback’и используют допустимые префиксы.

**10.2 CI**  
- `alembic upgrade head` на чистой временной БД.  
- Юнит‑тесты ядра.  
- Smoke‑сценарии (см. §12).

**10.3 CD**  
- Порядок: миграции → деплой → healthcheck → перевес трафика.  
- Чек‑лист релиза + план отката.

---

## 11) Контракт для внешних исполнителей/моделей

**Запрещено:**  
- Менять тексты кнопок вне UI‑констант.  
- Переиспользовать чужие префиксы.  
- Добавлять поля в код без миграции.  
- Мутировать `CallbackQuery`/`Message` объекты.  
- Звать LLM из шагов визардов/кнопок.

**Обязано:**  
- Новый код — в собственном неймспейсе callback’ов.  
- Поддержка «чистого экрана»: удаление промежуточных сообщений, закрытие inline‑панелей.  
- Все изменения проходят smoke‑проверку.

---

## 12) Smoke‑сценарии (каждый PR/релиз)

1) **Панель вкладок** видна всегда; не «сворачивается».  
2) Любая inline‑панель исчезает после действия; пользовательский ввод подчищен.  
3) **Импорт**: отправка файла → импорт last из меню → успешно, без 500/404; повторная отправка идентичного файла не плодит дубликат.  
4) **LLM**: при `LLM_DISABLED=1` ни одна кнопка/визард не инициирует реальный вызов; единственная точка — свободный текст в «вооружённом» состоянии (возвращает stub).  
5) **Миграции**: чистая БД → `alembic upgrade head` без ошибок; сервис не стартует, если ревизия не head.  
6) **Сервисные тексты** не попадают в catch‑all.  
7) **Доступ к медиа** соответствует владельцу; попытки чужого доступа — отказ.

---

## 13) Что доработать в Lovender по этой Конституции

- **Вынести UI‑тексты** в единый модуль (если где-то остались «магические строки»).  
- **Проверить неймспейсы** callback’ов — доменные префиксы без пересечений.  
- **Закрепить ensure_toolbar** как единственный способ держать нижнюю панель; исключить дубли сообщений‑держателей.  
- **Гарантировать удаление** пользовательских ответов (проверить все места ввода).  
- **Миграции:** стандартизировать имена, проверить `merge_heads`, добавить жёсткую проверку ревизии на старте.  
- **Public ID:** ввести ULID/шаблон для внешних ссылок/идентификаторов, если ещё не введён.  
- **Медиа:** убедиться, что логика — только по `file_id`, с метаданными и доступами; тяжёлые операции — фоново.  
- **LLM‑контур:** централизованный стоп‑кран и единая точка вызова (даже если LLM пока не используется).  
- **Smoke‑набор** — автоматизировать в CI (минимум сценариев из §12).

---

## 14) Формат задач/PR

- Ссылка на этот документ в описании.  
- Список затронутых доменов/префиксов callback’ов.  
- Есть ли новые миграции? План отката.  
- Список пройденных smoke‑сценариев.  
- Изменения UI‑текстов только через константы.

---

## 15) Итог

Эта Конституция — базис. Конкретные визарды (dating‑анкеты, поиск, и т.п.) — **надстройка**, но их шаги обязаны
соблюдать общие инварианты: чистый экран, атомарные состояния, единая точка LLM, предсказуемые миграции и строгие контракты UI/маршрутизации.
