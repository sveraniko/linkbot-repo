
# ASK‚ÄëWIZARD v3 ‚Äî Answer Bar: Persistence + Icons‚Äëonly + Sources fix

> –ó–∞–¥–∞—á–∞: –¥–æ–≤–µ—Å—Ç–∏ –ø–∞–Ω–µ–ª—å –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–¥ –æ—Ç–≤–µ—Ç–æ–º LLM –¥–æ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ UX:
> **–∏–∫–æ–Ω–∫–∏ –±–µ–∑ —Ç–µ–∫—Å—Ç–∞**, **–ø–∞–Ω–µ–ª—å –≤—Å–µ–≥–¥–∞ –Ω–∞ –º–µ—Å—Ç–µ**, `üìö Sources` –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç —Å –¥—Ä—É–≥–∏–º–∏ callback‚Äô–∞–º–∏, –∏ –Ω–∏ –æ–¥–Ω–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ ¬´—Å—ä–µ–¥–∞–µ—Ç¬ª –ø–∞–Ω–µ–ª—å.

---

## 0) –°–∏–º–ø—Ç–æ–º—ã —Å–µ–π—á–∞—Å (–ø–æ—á–µ–º—É –ø—Ä–∞–≤–∏–º)
- –ö–Ω–æ–ø–∫–∏ —É—à–ª–∏ –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É —Å —Ç–µ–∫—Å—Ç–∞–º–∏ ‚Äî —á–∏—Ç–∞–µ—Ç—Å—è —Ç—è–∂–µ–ª–æ.
- –ù–∞–∂–∞—Ç–∏–µ `üìö Sources` –ø–æ–ø–∞–¥–∞–µ—Ç –≤ —á—É–∂–æ–π —Ö–µ–Ω–¥–ª–µ—Ä (–≤–∏–¥–Ω–æ –ø–æ `‚úÖ –®–∞–±–ª–æ–Ω –≤—ã–±—Ä–∞–Ω‚Ä¶`) ‚Äî **–∫–æ–Ω—Ñ–ª–∏–∫—Ç –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤ callback‚Äëdata**.
- –ü–æ—Å–ª–µ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –ø–∞–Ω–µ–ª—å **–ø—Ä–æ–ø–∞–¥–∞–µ—Ç** (–Ω–µ—Ç `reply_markup` –≤ `edit_message_text`).

---

## 1) –ß—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å (UX-–∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã)

1. **–ò–∫–æ–Ω–∫–∏‚Äë—Ç–æ–ª—å–∫–æ** –≤ –ø–∞–Ω–µ–ª–∏ –ø–æ–¥ –æ—Ç–≤–µ—Ç–æ–º (–±–µ–∑ –ø–æ–¥–ø–∏—Å–µ–π). –ù–∞–±–æ—Ä –∏ –ø–æ—Ä—è–¥–æ–∫:
   - –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ (–∏–ª–∏ –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞): `üíæ` `üìå/üìç` `üßæ` `üîÅ` `üìö` `üóë`
2. **–ü–∞–Ω–µ–ª—å –≤—Å–µ–≥–¥–∞ –Ω–∞ –º–µ—Å—Ç–µ**. –õ—é–±–æ–π `edit_message_text` –ø–æ —ç—Ç–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é **–æ–±—è–∑–∞–Ω** –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å `reply_markup=actions_keyboard(run_id, state)`.
3. **–ù–∏–∫–∞–∫–∏—Ö –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π** –æ—Ç –∫–Ω–æ–ø–æ–∫; —Ç–æ–ª—å–∫–æ –≤—Å–ø–ª—ã–≤–∞—à–∫–∏ `answerCallbackQuery` + —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã.
4. `üìö` –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç **–æ–≤–µ—Ä–ª–µ–π –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤** (–ø–µ—Ä–µ–∫–ª–∞–¥–∫–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã), –∞ –Ω–µ –¥—Ä—É–≥–æ–π –º–æ–¥—É–ª—å.

---

## 2) –ù–µ–π–º—Å–ø–µ–π—Å—ã –∏ –∫–æ–ª–ª–∏–∑–∏–∏ (–∂—ë—Å—Ç–∫–æ)

–í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –æ—Ç–≤–µ—Ç–∞ ‚Äî **—Ç–æ–ª—å–∫–æ** –≤ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ `ask:answer:*`:

- `ask:answer:save:<run_id>`
- `ask:answer:pin:<answer_id|temp>`
- `ask:answer:summary:<answer_id|temp>`
- `ask:answer:delete:<answer_id|msg_id>`
- `ask:answer:refine:<run_id>`
- `ask:answer:sources:<run_id>`
- `ask:answer:sources:back:<run_id>`
- `ask:answer:open:<answer_id>` (–µ—Å–ª–∏ –ø–æ—Å–ª–µ `Save` –ø–æ–∫–∞–∑—ã–≤–∞–µ–º `üóÇ`)

–ó–∞–ø—Ä–µ—â–µ–Ω–æ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–µ—Ñ–∏–∫—Å—ã `template:*`, `menu:*` –∏ —Ç. –ø. –†–æ—É—Ç–µ—Ä –¥–æ–ª–∂–µ–Ω –º–∞—Ç—á–∏—Ç—å `ask:answer:*` **—Ä–∞–Ω—å—à–µ** ¬´–æ–±—â–∏—Ö¬ª.

---

## 3) –†–∞—Å–∫–ª–∞–¥–∫–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (–¥–≤–µ –æ–ø—Ü–∏–∏)

### –í–∞—Ä–∏–∞–Ω—Ç A (–æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞, **–∏–∫–æ–Ω–∫–∏‚Äë—Ç–æ–ª—å–∫–æ**)
`[üíæ] [üìå/üìç] [üßæ] [üîÅ] [üìö] [üóë]`

### –í–∞—Ä–∏–∞–Ω—Ç B (–¥–≤–µ —Å—Ç—Ä–æ–∫–∏, –µ—Å–ª–∏ —à–∏—Ä–∏–Ω—ã –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç)
1‚Äë—è: `[üíæ] [üìå/üìç] [üßæ]`  
2‚Äë—è: `[üîÅ] [üìö] [üóë]`

> –í–≤–µ—Å—Ç–∏ —Ñ–ª–∞–≥ –æ–∫—Ä—É–∂–µ–Ω–∏—è `ANSWER_BAR_ICONS_ONLY=1` –∏ `ANSWER_BAR_WRAP=auto|1|2`.
> –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: `ICONS_ONLY=1`, `WRAP=auto`.

–î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ–¥—Å–∫–∞–∑–∫–∏ –¥–∞—ë–º **–≤—Å–ø–ª—ã–≤–∞—à–∫–æ–π** –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∫–ª–∏–∫–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç¬ª).

---

## 4) –ü–æ–≤–µ–¥–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ (–∫—Ä–∞—Ç–∫–æ ‚Äî –≤ —Å–∏–Ω—Ö—Ä–æ–Ω–µ —Å Answer‚ÄëActions SPEC)

- `üíæ Save` ‚Üí —Å–æ–∑–¥–∞—ë–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç `kind/tag=answer`; –º–µ–Ω—è–µ–º `üíæ` –Ω–∞ `‚úÖ` (–∏–ª–∏ `üóÇ`). `_toast("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ")`.
- `üìå/üìç Pin` ‚Üí —Ç—É–º–±–ª–µ—Ä —Ç–µ–≥–∞ `pinned`; –∏–∫–æ–Ω–∫–∞ –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ –º–µ—Å—Ç–µ. `_toast("–ó–∞–∫—Ä–µ–ø–ª–µ–Ω–æ/–û—Ç–∫—Ä–µ–ø–ª–µ–Ω–æ")`.
- `üßæ Summary` ‚Üí –¥–æ–±–∞–≤–ª—è–µ–º –±–ª–æ–∫ `## Summary` –∫ **—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–º—É** (–µ—Å–ª–∏ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ ‚Äî —Å–Ω–∞—á–∞–ª–∞ Save). `_toast("–°–≤–æ–¥–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞")`.
- `üîÅ Refine` ‚Üí ForceReply ¬´–ß–µ–º —É—Ç–æ—á–Ω–∏—Ç—å?¬ª, —É–¥–∞–ª—è–µ–º –≤–≤–æ–¥, **—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º** —ç—Ç–æ –∂–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–æ–≤—ã–º –æ—Ç–≤–µ—Ç–æ–º; –ø–∞–Ω–µ–ª—å —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –∑–∞–Ω–æ–≤–æ.
- `üìö Sources` ‚Üí **–ø–µ—Ä–µ–∫–ª–∞–¥—ã–≤–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É** (–Ω–µ —Ç–µ–∫—Å—Ç!):
  - –ù–∞ –º–µ—Å—Ç–µ –ø–∞–Ω–µ–ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏‚Äë—á–∏–ø—ã –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤: `[#tag id12] [–û—Ç–∫—Ä—ã—Ç—å]` ‚Ä¶ –∏ –∫–Ω–æ–ø–∫—É `‚Ü©Ô∏è Back` (`ask:answer:sources:back:<run_id>`).
  - –ü–æ `‚Ü©Ô∏è Back` –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –ø–∞–Ω–µ–ª—å.
- `üóë Delete` ‚Üí –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ alert; –∑–∞—Ç–µ–º `deleteMessage` –∏ (–µ—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ) –ø–æ–º–µ—á–∞–µ–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç –∫–∞–∫ —É–¥–∞–ª—ë–Ω–Ω—ã–π.

---

## 5) –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è (—á—Ç–æ–±—ã –ø–∞–Ω–µ–ª—å **–Ω–µ –∏—Å—á–µ–∑–∞–ª–∞**)

- **–ü—Ä–∞–≤–∏–ª–æ 5.1.** –õ—é–±–æ–π –≤—ã–∑–æ–≤ `edit_message_text` –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—é –æ—Ç–≤–µ—Ç–∞ **–æ–±—è–∑–∞–Ω** –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å `reply_markup=actions_keyboard(...)`. –ë–µ–∑ —ç—Ç–æ–≥–æ Telegram **—Å–Ω–∏–º–µ—Ç** –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É.
- **–ü—Ä–∞–≤–∏–ª–æ 5.2.** –•—Ä–∞–Ω–∏–º `run_id`, `answer_id`, `saved:boolean`, `pinned:boolean` –≤ —Å—Ç–µ–π—Ç–µ –æ—Ç–≤–µ—Ç–∞, —á—Ç–æ–±—ã –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –±—ã–ª–∞ –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π.
- **–ü—Ä–∞–≤–∏–ª–æ 5.3.** –î–ª—è `üìö Sources`: –º–µ–Ω—è–µ–º **—Ç–æ–ª—å–∫–æ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É** (—á–µ—Ä–µ–∑ `edit_message_reply_markup`), –Ω–µ —Ç—Ä–æ–≥–∞–µ–º —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞.
- **–ü—Ä–∞–≤–∏–ª–æ 5.4.** –õ—é–±—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ ‚Äî `answerCallbackQuery` (–±–µ–∑ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π).
- **–ü—Ä–∞–≤–∏–ª–æ 5.5.** –ü–æ—Å–ª–µ `Refine`: —ç—Ç–æ **–Ω–æ–≤—ã–π run_id**. –ü–∞–Ω–µ–ª—å —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –≤ –¥–µ—Ñ–æ–ª—Ç (–Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ), –Ω–æ –Ω–µ –∏—Å—á–µ–∑–∞–µ—Ç.

---

## 6) Acceptance (—á—Ç–æ –ø–æ–∫–∞–∑–∞—Ç—å)

1) –ü–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ –≤–∏–∂—É –∏–∫–æ–Ω–∫–∏: `üíæ üìå üßæ üîÅ üìö üóë`. –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ `ANSWER_BAR_WRAP` —Ä–∞—Å–∫–ª–∞–¥—ã–≤–∞–µ—Ç –≤ –¥–≤–µ —Å—Ç—Ä–æ–∫–∏.
2) –ù–∞–∂–∏–º–∞—é `üìö` ‚Äî —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ **–Ω–µ –º–µ–Ω—è–µ—Ç—Å—è**; –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –∏ `‚Ü©Ô∏è Back`. –ü–æ `Back` –ø–∞–Ω–µ–ª—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è.
3) –ù–∞–∂–∏–º–∞—é `üíæ` ‚Äî –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ `‚úÖ`/`üóÇ`; `_toast("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ")`. –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∫–ª–∏–∫ ‚Üí `_toast("–£–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ")`.
4) `üìå` –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ `üìç` –∏ –æ–±—Ä–∞—Ç–Ω–æ; `üßæ` –¥–æ–±–∞–≤–ª—è–µ—Ç –±–ª–æ–∫ —Å–≤–æ–¥–∫–∏ –≤ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç; `üîÅ` –¥–µ–ª–∞–µ—Ç –Ω–æ–≤—ã–π –æ—Ç–≤–µ—Ç **–≤ —Ç–æ–º –∂–µ —Å–æ–æ–±—â–µ–Ω–∏–∏**, –ø–∞–Ω–µ–ª—å –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–µ–Ω–∞; `üóë` —É–¥–∞–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ.
5) –ù–∏ –æ–¥–∏–Ω –∫–ª–∏–∫ –Ω–µ —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã—Ö ¬´–º—É—Å–æ—Ä–Ω—ã—Ö¬ª —Å–æ–æ–±—â–µ–Ω–∏–π; –º–∞–∫—Å–∏–º—É–º ‚Äî –≤—Å–ø–ª—ã–≤–∞—à–∫–∞.
6) `üìö` **–Ω–µ** —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç ¬´—à–∞–±–ª–æ–Ω—ã¬ª/–¥—Ä—É–≥–∏–µ –º–æ–¥—É–ª–∏ (–∫–æ–ª–ª–∏–∑–∏–π –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤ –Ω–µ—Ç).

---

## 7) –ì–¥–µ –ø—Ä–∞–≤–∏–º (–º–∏–Ω–∏–º–∞–ª—å–Ω–æ)

- `app/handlers/ask.py`:
  - –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä `actions_keyboard(run_id, state, layout_flags)`;
  - —Ö–µ–Ω–¥–ª–µ—Ä—ã `ask:answer:*` (—Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º –Ω–∞–¥ –æ–±—â–∏–º–∏);
  - –≤ –º–µ—Å—Ç–∞—Ö `edit_message_text` ‚Äî –≤—Å–µ–≥–¥–∞ –ø—Ä–æ–∫–∏–¥—ã–≤–∞—Ç—å `reply_markup` –ø–∞–Ω–µ–ª–∏.

- `app/services/answers.py`:
  - `save_answer(...)`, `toggle_pin(...)`, `add_summary(...)`, `delete_answer(...)` ‚Äî —á–∏—Å—Ç—ã–µ —Å–µ—Ä–≤–∏—Å—ã –±–µ–∑ Telegram‚Äë–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π.

- `app/utils/tg.py`:
  - `_toast`, `edit_kbd`, `safe_delete` ‚Äî —É–∂–µ –µ—Å—Ç—å –∏–∑ –ø—Ä–æ—à–ª—ã—Ö –∑–∞–¥–∞—á.

- `env/config`:
  - `ANSWER_BAR_ICONS_ONLY=1` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é);
  - `ANSWER_BAR_WRAP=auto` (–∏–ª–∏ `1/2`).

---

**–ò—Ç–æ–≥:** –ø–∞–Ω–µ–ª—å –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–¥ –æ—Ç–≤–µ—Ç–æ–º –≤—Å–µ–≥–¥–∞ –Ω–∞ –º–µ—Å—Ç–µ, –±–µ–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –∏ —Å–ø–∞–º–∞; `üìö Sources` —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –∏ –¥–∞–∂–µ –ø—Ä–∏ Refine/—Ä–µ–¥–∞–∫—Ç–∞—Ö –º—ã –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –Ω–µ —Ç–µ—Ä—è–µ–º.
