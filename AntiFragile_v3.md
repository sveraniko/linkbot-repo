# Конституция ботов (v3): Антихрупкость ++

> Эта версия дополняет и ужесточает текущую «Конституцию ботов» по трём болевым точкам:  
> **(1)** безопасный вывод (MarkdownV2/HTML‑экранирование), **(2)** «UTF‑8 везде» и юникод‑нормализация (импорт кириллицы), **(3)** устойчивый поиск/выборка (анти‑дубли, корректная область проекта, отсутствие LLM в служебных шагах).  
> Базовый каркас/принципы берем из действующей версии документа. 
> 
> Ключ: все пункты — **обязательные инварианты**, а не рекомендации.


---
## 0) Что изменилось по сравнению с v2
- Добавлен раздел **Safe Rendering & MarkdownV2 Escaping** (единый слой экранирования; запрет «мусорных» сообщений).
- Добавлен раздел **UTF‑8 Everywhere & Unicode Normalization (NFC)**: автодетект кодировок при импорте, хранение и поиск кириллицы без «�».
- Раздел **Поиск/Выборка** расширен: инварианты SQL (subquery‑distinct вместо DISTINCT ON), зоны проекта (active+linked), детерминированная пагинация «5 на страницу», парсер `id/#tag/name`.
- Жёсткие правила **Callback‑Data** (base64url/short), неймспейсы префиксов, size‑budget.
- Расширены **Smoke‑сценарии**: проверки экранирования, импорта кириллицы и работоспособности поиска.


---
## 1) Safe Rendering & MarkdownV2/HTML Escaping (Messaging Hygiene)

**Инвариант 1.1. Центральный экранировщик.**  
Любой текст, который уходит в Telegram с `parse_mode=MarkdownV2`, проходит через единый `escape_markdown_v2()`.  
Экранируются все спецсимволы MarkdownV2:  
`_ * [ ] ( ) ~ ` + > # - = | { } . !` (каждый — обратным слэшем).  
Альтернатива: `parse_mode=HTML` + HTML‑экранирование `& < > " '`.

**Инвариант 1.2. Никаких «мусорных» служебных сообщений.**  
Статусы «добавлен/убран», «ничего не найдено», «страница X/Y» — **только** через `answerCallbackQuery` или редактирование уже существующих сообщений. 
ForceReply‑подсказки и ответы пользователя — **удаляем** (TTL).

**Инвариант 1.3. Единые helper’ы UI.**  
В проекте есть: `_toast(cb, text)`, `_send_ephemeral(msg, text, ttl)`, `_safe_delete(chat_id, msg_ids)`.  
Хранилище id сообщений страницы: `ask_page_msg_ids`, `ask_footer_msg_id`, `ask_prompt_msg_id`.


---
## 2) UTF‑8 Everywhere & Unicode Normalization (импорт кириллицы)

**Инвариант 2.1. Декодирование файлов.**  
- Пытаемся `utf‑8`/`utf‑8‑sig`; при неудаче — autodetect (cp1251 и пр.), с явным логом.  
- Содержимое и имена файлов нормализуем в **NFC** (`unicodedata.normalize('NFC', ...)`).

**Инвариант 2.2. База и клиент.**  
- PostgreSQL в `UTF8`, `client_encoding=UTF8`.  
- Текстовые поля `TEXT`/`CITEXT` (если нужно case‑insensitive).  
- Поиск — через `LOWER(field) LIKE LOWER('%term%')` (или `ILIKE`), чтобы кириллица искалась одинаково.

**Инвариант 2.3. Public‑ID и slug.**  
- Внешний `public_id` (ULID/KSUID/шаблон) хранится **дополнительно** к numeric `id`.  
- Для slug: либо транслитерируем, либо храним оригинал + машинный slug (оба нормализованы в NFC).


---
## 3) Поиск/Выборка: анти‑дубли, корректная область, без LLM

**Инвариант 3.1. Область проекта.**  
Запрос всегда ограничивается объединением: `[active_project_id] + linked_project_ids`.  
Если список пуст (теоретически) — область не фильтруем (иначе нули).

**Инвариант 3.2. Парсер термина.**  
- `^\d+$` → поиск по `id` (точное).  
- `^#(.+)$` → по тегу (lower‑LIKE `%term%`).  
- Иначе → по названию (`LOWER(title) LIKE %term%`).

**Инвариант 3.3. Правильный SQL‑скелет.**  
Запрещено использовать `DISTINCT ON` с неподходящим `ORDER BY`.  
Используем **subquery‑distinct**:
- Подзапрос `sub(id)` с **всеми фильтрами** (`project_ids`, `mode/term`) и `DISTINCT`.  
- Внешний запрос по `id IN (sub)` + `ORDER BY created_at DESC` + `LIMIT/OFFSET`.  
- На UI — доп. уникализация по `id` перед рендером (страховка).

**Инвариант 3.4. Пагинация.**  
Рисуем **ровно 5 плашек** на страницу + шапка + футер; при `⬅️/➡️` удаляем старую «семёрку» и рисуем новую.  
Тумблер `➕/✅` меняет клавиатуру **на месте** (без «Обновить»).

**Инвариант 3.5. Stop LLM.**  
В шагах поиска/пагинации/тумблера/удаления/импорта — **ноль** вызовов LLM.  
Единственная точка LLM — свободный текст в «вооружённом» состоянии.


---
## 4) Callback‑data, неймспейсы и лимиты

**Инвариант 4.1. Неймспейсы.**  
Каждому домену — свой префикс (`ask:*`, `mem:*`, `act:*`, `imp:*`, …). Никаких пересечений.

**Инвариант 4.2. Размер и кодировка.**  
`callback_data` должен помещаться в лимит Telegram (<=64 байт полезной части).  
Динамические параметры (id/slug/term) кодируем **base64url/URL‑safe** и делаем короткими.  
Любые длинные данные — через storage по `key`, а в callback — только ключ.


---
## 5) Состояния и порядок роутеров (FSM/aiogram)

**Инвариант 5.1. Порядок.**  
1) Reply‑клава/Actions/Chat; 2) Визарды; 3) Общие панели; 4) **Catch‑all последним**.

**Инвариант 5.2. Флаги‑заглушки.**  
`awaiting_ask_search=True` → catch‑all молчит.  
Состояния `armed`, `auto_clear` и пр. хранятся в `user_state` и **сбрасываются** после шага.


---
## 6) Миграции (Alembic) и фича‑флаги

- Новая фича → новая миграция; старые миграции **не трогаем**.  
- Имена миграций: `YYYYMMDD_HHMM_slug.py`; строгий `down_revision`.  
- Сервис **не стартует**, если ревизия не `head` (жёсткая проверка на старте).  
- Новые поля — `NOT NULL DEFAULT` + серверный default.  
- Незрелая логика за `FEATURE_*` флагами (в dev/stage выключено по умолчанию).


---
## 7) Логи и метрики (минимум)

- Структурные логи (json): `request_id`, пользователь, действие, результат, длительность, ошибки.  
- Для поиска: логировать `mode`, `term`, `project_ids`, «найдено до/после пагинации».  
- Метрики: аптайм, ошибки, токены LLM (если включён), длина очередей задач.


---
## 8) Smoke‑сценарии (каждый PR/релиз)

1) **Экранирование**: сообщения с `_[](){}.!~` не падают, рендерятся корректно.  
2) **Импорт кириллицы**: файл с русским именем/контентом импортируется без `�`; поиск по фразе из файла работает.  
3) **Поиск**: `name`/`#tag`/`id` дают результат; страница=5; `⬅️/➡️` — старая «семёрка» удалена.  
4) **Stop LLM**: при `LLM_DISABLED=1` служебные шаги не трогают модель; `Ask` возвращает stub.  
5) **FSM**: при активном ForceReply catch‑all молчит; ввод/промпт удаляются после обработки.  
6) **Миграции**: `alembic upgrade head` на чистой БД проходит; сервис не поднимается, если не `head`.


---
## 9) «Красные линии» для подрядчиков/моделей

**Запрещено:** менять тексты кнопок вне UI‑констант, использовать чужие префиксы, добавлять поля без миграций, звать LLM из кнопок/поиска, плодить «мусорные» сообщения.  
**Обязательно:** неймспейсы, экранирование, `UTF‑8 Everywhere`, subquery‑distinct, «чистый экран», smoke‑сценарии в PR.


---
## 10) Применение к Lovender/Linkbot (что проверить в живом коде)

- Единый экранировщик и отсутствие «…» (всплывашки/редакты вместо новых сообщений).  
- Импорт русских файлов/имен; NFC‑нормализация; корректное отображение и поиск.  
- Поиск: область `active+linked`, парсер `id/#tag/name`, подзапрос‑distinct, 5‑на‑страницу.  
- Неймспейсы callback’ов без пересечений; размер callback‑data в лимите.  
- Миграции/флаги/логирование — как в инвариантах выше.
