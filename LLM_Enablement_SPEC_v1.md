# LLM Enablement ‚Äî SPEC (–≤–∫–ª—é—á–∞–µ–º –∑–≤–æ–Ω–æ–∫ –∫ –º–æ–¥–µ–ª–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ)

**–¶–µ–ª—å:** –≤–µ—Ä–Ω—É—Ç—å —Ä–∞–±–æ—Ç—É `‚ùì Ask` —Å –≤—ã–∑–æ–≤–æ–º LLM **—Ç–æ–ª—å–∫–æ** –∫–æ–≥–¥–∞ Chat: ON, —Å —É—á—ë—Ç–æ–º –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (active+linked –ø—Ä–æ–µ–∫—Ç—ã), –±—é–¥–∂–µ—Ç–∞ —Ç–æ–∫–µ–Ω–æ–≤ –∏ –Ω–∞—à–µ–π ¬´–≥–∏–≥–∏–µ–Ω—ã¬ª (—ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, —á–∏—Å—Ç—ã–π —ç–∫—Ä–∞–Ω, –±–µ–∑ –º—É—Å–æ—Ä–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π). –î–æ–∫—É–º–µ–Ω—Ç ‚Äî –¥–ª—è qoder, –±–µ–∑ –∫–æ–¥–∞, –Ω–æ —Å —Ç–æ—á–Ω—ã–º–∏ —à–∞–≥–∞–º–∏/–ø—Ä–∏—ë–º–∫–æ–π.

---

## 0) –ü—Ä–µ–¥—É—Å–ª–æ–≤–∏—è –∏ —Ñ–ª–∞–≥–∏
- Reply‚Äë–∫–ª–∞–≤–∞: `‚öôÔ∏è Actions` ‚Ä¢ `üí¨ Chat ON/OFF` ‚Ä¢ `‚ùì ASK‚ÄëWIZARD` (—É–∂–µ –µ—Å—Ç—å).
- Ask‚Äëwizard: –≤—ã–±–æ—Ä –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç (List + –ø–æ–∏—Å–∫ + –ø–∞–≥–∏–Ω–∞—Ü–∏—è).
- –§–ª–∞–≥–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
  - `LLM_DISABLED=0` (—Ä–∞–Ω–µ–µ –±—ã–ª–æ 1).
  - `LLM_MODEL=gpt-5-thinking` (–∏–ª–∏ –Ω—É–∂–Ω–∞—è –º–æ–¥–µ–ª—å).
  - `LLM_TIMEOUT=60` (—Å–µ–∫) –∏ `LLM_MAX_TOKENS_OUT`, `LLM_TEMPERATURE` ‚Äî –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º–æ.
- –ü–æ–ª—è —Å—Ç–µ–π—Ç–∞/–ë–î: `selected_artifact_ids`, `auto_clear_selection`, `active_project_id`, `linked_project_ids` ‚Äî –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç.

**–ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç:** –ù–∏ –æ–¥–∏–Ω —Å–ª—É–∂–µ–±–Ω—ã–π —à–∞–≥ (List/–ø–æ–∏—Å–∫/–ø–∞–≥–∏–Ω–∞—Ü–∏—è/—Ç—É–º–±–ª–µ—Ä/—É–¥–∞–ª–µ–Ω–∏–µ/–∏–º–ø–æ—Ä—Ç) **–Ω–µ** —Ç—Ä–æ–≥–∞–µ—Ç LLM.

---

## 1) –ü–æ—Ç–æ–∫ `‚ùì Ask` (—Ä–æ–≤–Ω–æ —Ç–∞–∫)

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∂–º—ë—Ç `‚ùì Ask` –≤ ASK‚ÄëWIZARD home.
2. –ï—Å–ª–∏ **Chat: OFF** ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ–º **–æ–¥–Ω–æ** —Å–æ–æ–±—â–µ–Ω–∏–µ ¬´–í–∫–ª—é—á–∏ —á–∞—Ç‚Ä¶¬ª —Å –∏–Ω–ª–∞–π–Ω‚Äë–∫–Ω–æ–ø–∫–æ–π ¬´–í–∫–ª—é—á–∏—Ç—å —á–∞—Ç¬ª –∏ **—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º** –µ–≥–æ –≤ ¬´–í–≤–µ–¥–∏ –≤–æ–ø—Ä–æ—Å‚Ä¶¬ª –ø–æ—Å–ª–µ –∫–ª–∏–∫–∞ (–±–µ–∑ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π).
3. –ï—Å–ª–∏ **Chat: ON** ‚Üí —Å—Ä–∞–∑—É ForceReply ¬´–í–≤–µ–¥–∏ –≤–æ–ø—Ä–æ—Å‚Ä¶¬ª (—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å `ask_prompt_msg_id`).
4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—Å—ã–ª–∞–µ—Ç –≤–æ–ø—Ä–æ—Å. –•–µ–Ω–¥–ª–µ—Ä:
   - –£–¥–∞–ª—è–µ—Ç —Å–∞–º –≤–æ–ø—Ä–æ—Å –∏ –ø—Ä–æ–º–ø—Ç (TTL=0..2 —Å–µ–∫, –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ).
   - –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç: –µ—Å—Ç—å –ª–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏? –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –≤—Å–ø–ª—ã–≤–∞—à–∫–∞ `answerCallbackQuery("–í—ã–±–µ—Ä–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∏")` –∏ –≤–æ–∑–≤—Ä–∞—Ç –≤ List.
   - –°—Ç–∞—Ä—Ç—É–µ—Ç –ø–∞–π–ø–ª–∞–π–Ω LLM (–ø.2), –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç **–æ–¥–Ω–æ** —Å–æ–æ–±—â–µ–Ω–∏–µ ¬´–ì–æ—Ç–æ–≤–ª—é –æ—Ç–≤–µ—Ç‚Ä¶¬ª (—ç–ø–µ–º–µ—Ä–Ω–æ–µ, –ø–æ—Ç–æ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç).

5. –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –º–æ–¥–µ–ª–∏ ‚Üí —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º ¬´–ì–æ—Ç–æ–≤–ª—é –æ—Ç–≤–µ—Ç‚Ä¶¬ª –≤ **–∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç–≤–µ—Ç**, —Å–Ω–∏–∑—É –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º —á–∏–ø‚Äë—Å—Ç—Ä–æ–∫—É –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –∏ –∫–Ω–æ–ø–∫–∏: `üîÅ Refine` (–ø–æ–≤—Ç–æ—Ä —Å —É—Ç–æ—á–Ω–µ–Ω–∏–µ–º), `üìö –ò—Å—Ç–æ—á–Ω–∏–∫–∏` (–≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ List), `üßπ –û—á–∏—Å—Ç–∏—Ç—å` (–µ—Å–ª–∏ Auto‚Äëclear: OFF).  
6. –ï—Å–ª–∏ `auto_clear_selection=ON` ‚Üí –æ—á–∏—â–∞–µ–º `selected_artifact_ids` **–ø–æ—Å–ª–µ** –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞ (–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –±—é–¥–∂–µ—Ç –≤ home‚Äë–ø–∞–Ω–µ–ª–∏).

---

## 2) –ü–∞–π–ø–ª–∞–π–Ω LLM (–¥–µ—Ç–∞–ª—å–Ω–æ, –±–µ–∑ –∫–æ–¥–∞)

### 2.1 –°–±–æ—Ä –≤—Ö–æ–¥–∞
- `project_ids = [active_project_id] + linked_project_ids` (—É–Ω–∏–∫–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å).
- `source_ids = selected_artifact_ids` (–µ—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî –ø—Ä–µ—Ä—ã–≤–∞–µ–º —Å –ø–æ–¥—Å–∫–∞–∑–∫–æ–π).
- –ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (–Ω–∞–∑–≤–∞–Ω–∏–µ, —Ç–µ–≥–∏, –¥–∞—Ç–∞, —Ä–∞–∑–º–µ—Ä, –ø—É—Ç–∏ –∫ —á–∞–Ω–∫–∞–º).

### 2.2 –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (RAG‚Äë–≤–≤–æ–¥)
- –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ —Ç—è–Ω–µ–º **–≥–æ—Ç–æ–≤—ã–µ —á–∞–Ω–∫–∏/—Ä–µ–∑—é–º–µ** (–µ—Å–ª–∏ –µ—Å—Ç—å –≤ –ë–î) –∏–ª–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç (–Ω–µ –≤–µ—Å—å —Ñ–∞–π–ª).
- –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –≤ **UTF‚Äë8** + **NFC**; —á–∏—Å—Ç–∏–º —É–ø—Ä–∞–≤–ª—è—é—â–∏–µ –∏ –Ω—É–ª–µ–≤—ã–µ —Å–∏–º–≤–æ–ª—ã.
- –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã —á–∞–Ω–∫–æ–≤ (–ø–æ —Ö–µ—à—É/–∏–¥–µ–Ω—Ç–∏—á–Ω–æ–º—É —Ç–µ–∫—Å—Ç—É).

### 2.3 –ë—é–¥–∂–µ—Ç —Ç–æ–∫–µ–Ω–æ–≤
- –ü–æ–ª—É—á–∞–µ–º `model_context_limit` (–Ω–∞–ø—Ä–∏–º–µ—Ä, 128k).  
- –†–µ–∑–µ—Ä–≤–∏—Ä—É–µ–º `out_tokens = LLM_MAX_TOKENS_OUT` –∏ `system_tokens ‚âà const`.
- –î–æ—Å—Ç—É–ø–Ω—ã–π –≤—Ö–æ–¥: `in_budget = limit - out_tokens - system_tokens - margin`.
- –ê–ª–ª–æ—Ü–∏—Ä—É–µ–º –±—é–¥–∂–µ—Ç **–ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º** (—Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ –ª–∏–±–æ —Å –≤–µ—Å–æ–º ¬´–Ω–æ–≤–µ–µ/–≤–∞–∂–Ω–µ–µ¬ª).  
- –ï—Å–ª–∏ —Å—É–º–º–∞—Ä–Ω–æ > `in_budget` ‚Üí **–æ–±—Ä–µ–∑–∞–µ–º** –ø–æ —á–∞–Ω–∫–∞–º: –±–µ—Ä—ë–º –ø–µ—Ä–≤—ã–µ N —á–∞–Ω–∫–æ–≤ –∫–∞–∂–¥–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –¥–æ —Å–≤–æ–µ–≥–æ –ª–∏–º–∏—Ç–∞, –æ—Å—Ç–∞–ª—å–Ω–æ–µ –æ—Ç–±—Ä–∞—Å—ã–≤–∞–µ–º (–∏–ª–∏ —Å–∂–∏–º–∞–µ–º —Ä–µ–∑—é–º–µ, –µ—Å–ª–∏ –µ—Å—Ç—å).

### 2.4 –°–±–æ—Ä–∫–∞ –ø—Ä–æ–º–ø—Ç–∞
- **System**: –∂—ë—Å—Ç–∫–∏–π —à–∞–±–ª–æ–Ω (—Ä–æ–ª—å –±–æ—Ç–∞, —Å—Ç–∏–ª—å, ¬´—Å—Å—ã–ª–∞–π—Å—è –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∏, –Ω–µ –≤—ã–¥—É–º—ã–≤–∞–π¬ª, —Ä—É—Å/eng –∏ –ø—Ä.).
- **Context**: –±–ª–æ–∫ `SOURCES:` ‚Äî –Ω–∞ –∫–∞–∂–¥—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫: –∫—Ä–∞—Ç–∫–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ + –¥–æ K —á–∞–Ω–∫–æ–≤ (–º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫), **—Å–æ —Å—Å—ã–ª–∫–æ–π –Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π id** (–¥–ª—è —Å—Å—ã–ª–æ–∫ –≤ –æ—Ç–≤–µ—Ç–µ).
- **User**: –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–π —á–µ—Ä–µ–∑ **MarkdownV2/HTML —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ** –∏ JSON‚Äë–±–µ–∑–æ–ø–∞—Å–Ω—É—é —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—é (–µ—Å–ª–∏ –Ω–∞–¥–æ).
- **Meta**: –∞–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–µ–∫—Ç, –¥–∞—Ç–∞/–≤—Ä–µ–º—è, —Ç–µ–∫—É—â–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ), `Auto‚Äëclear` (–Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –º–æ–¥–µ–ª–∏, –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω–æ).

### 2.5 –í—ã–∑–æ–≤ –º–æ–¥–µ–ª–∏
- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ ENV: `model`, `temperature`, `max_tokens`, `timeout`.
- **–°—Ç—Ä–∏–º–∏–Ω–≥** –æ–ø—Ü–∏–æ–Ω–∞–ª–µ–Ω; –µ—Å–ª–∏ –≤–∫–ª—é—á—ë–Ω ‚Äî —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ —á–∞–Ω–∫–∞–º, –∏–Ω–∞—á–µ ‚Äî —Ä–∞–∑–æ–≤–æ.
- –¢–∞–π–º–∞—É—Ç/—Ä–µ—Ç—Ä–∞–∏: 1..2 —Ä–µ—Ç—Ä–∞—è –ø–æ 429/5xx, —Å –±—ç–∫–æ—Ñ—Ñ–æ–º.

### 2.6 –ü–æ—Å—Ç‚Äë–æ–±—Ä–∞–±–æ—Ç–∫–∞
- –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç (MarkdownV2/HTML).  
- –í–Ω–∏–∑—É **—á–∏–ø‚Äë—Å—Ç—Ä–æ–∫–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤** –≤–∏–¥–∞: `üìö –ò—Å—Ç–æ—á–Ω–∏–∫–∏: [#woman id12], [#plan id13], ‚Ä¶` (–±–µ–∑ –æ–≥—Ä–æ–º–Ω—ã—Ö –±–ª–æ–∫–æ–≤).  
- –õ–æ–≥–∏—Ä—É–µ–º –º–µ—Ç—Ä–∏–∫–∏: `duration_ms`, `tokens_in/out`, `model`.

### 2.7 –û—à–∏–±–∫–∏
- `Context length` ‚Üí –º—è–≥–∫–∏–π –¥–∞—É–Ω—Å–∫–µ–π–ª: —Å–∏–ª—å–Ω–µ–µ —É–∂–∏–º–∞–µ–º –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º –∏ –ø–æ–≤—Ç–æ—Ä—è–µ–º –æ–¥–∏–Ω —Ä–∞–∑; –µ—Å–ª–∏ —Å–Ω–æ–≤–∞ ‚Äî —Å–æ–æ–±—â–∞–µ–º ¬´–í–æ–ø—Ä–æ—Å —Å–ª–∏—à–∫–æ–º –æ–±—ä—ë–º–Ω—ã–π, —Å–æ–∫—Ä–∞—Ç–∏ –∑–∞–ø—Ä–æ—Å –∏–ª–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∏¬ª.
- –°–µ—Ç—å/429 ‚Üí –ø–æ–ø–∞–ø ¬´—Å–µ—Ä–≤–∏—Å –∑–∞–Ω—è—Ç, –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ¬ª + —Ä–µ—Ç—Ä–∞–π/–æ—Ç–º–µ–Ω–∞.
- –õ—é–±–∞—è –Ω–µ–ø–æ–π–º–∞–Ω–Ω–∞—è ‚Äî –∫–æ—Ä–æ—Ç–∫–∏–π human‚Äëfriendly –æ—à–∏–±–æ—á–Ω—ã–π –æ—Ç–≤–µ—Ç + –ª–æ–≥.

---

## 3) UI/UX ‚Äî ¬´—á–∏—Å—Ç—ã–π —ç–∫—Ä–∞–Ω¬ª
- –í–º–µ—Å—Ç–æ –Ω–æ–≤—ã—Ö ¬´‚Ä¶¬ª ‚Äî `answerCallbackQuery` –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.
- ForceReply-–ø—Ä–æ–º–ø—Ç –∏ –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî **—É–¥–∞–ª—è—é—Ç—Å—è** –ø–æ—Å–ª–µ –ø—Ä–∏—ë–º–∞.
- –ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ List –≤—Å–µ–≥–¥–∞ —Ç–æ–ª—å–∫–æ 7 —Å–æ–æ–±—â–µ–Ω–∏–π (—à–∞–ø–∫–∞ + 5 –ø–ª–∞—à–µ–∫ + —Ñ—É—Ç–µ—Ä); –Ω–∞ –æ—Ç–≤–µ—Ç LLM ‚Äî –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ.
- –í –æ—Ç–≤–µ—Ç–µ –Ω–µ –≤—Å—Ç–∞–≤–ª—è—Ç—å –ª–∏—à–Ω–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –±–ª–æ–∫–∏; —Ç–æ–ª—å–∫–æ –∏—Ç–æ–≥ –∏ —á–∏–ø‚Äë—Å—Ç—Ä–æ–∫—É –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤.

---

## 4) –ì–¥–µ –≤–∫–ª—é—á–∞—Ç—å (—Ç–æ—á–∫–∏ –≤ –∫–æ–¥–µ –±–µ–∑ –¥–µ—Ç–∞–ª–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏)

1) `app/handlers/ask.py`
   - `ask_open_home` ‚Äî –∫–Ω–æ–ø–∫–∞ `‚ùì Ask` –∞–∫—Ç–∏–≤–Ω–∞ –ø—Ä–∏ `selected_artifact_ids`>0.
   - `ask_start` ‚Äî ForceReply (–∏–ª–∏ ¬´–í–∫–ª—é—á–∏—Ç—å —á–∞—Ç¬ª –ø—Ä–∏ Chat: OFF).
   - `ask_receive_question` ‚Äî **—É–¥–∞–ª—è–µ—Ç** –ø—Ä–æ–º–ø—Ç –∏ –≤–æ–ø—Ä–æ—Å, –∑–∞–ø—É—Å–∫–∞–µ—Ç `run_llm_pipeline(...)`, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç ¬´–ì–æ—Ç–æ–≤–ª—é –æ—Ç–≤–µ—Ç‚Ä¶¬ª –∏ –∑–∞—Ç–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç –µ–≥–æ –Ω–∞ –∏—Ç–æ–≥.
   - `run_llm_pipeline(...)` ‚Äî –≤—ã–∑–æ–≤ —Å–µ—Ä–≤–∏—Å–æ–≤ –∏–∑ –ø.2, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç (text, used_source_ids, tokens_in/out).

2) `app/services/llm.py` ‚Äî –æ–±—ë—Ä—Ç–∫–∞ –≤–æ–∫—Ä—É–≥ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ (–º–æ–¥–µ–ª—å, —Ç–∞–π–º–∞—É—Ç—ã, —Ä–µ—Ç—Ä–∞–∏).  
3) `app/services/retrieval.py` ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤/—á–∞–Ω–∫–æ–≤.  
4) `app/services/prompt_builder.py` ‚Äî —Å–±–æ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ/–∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ/—é–∑–µ—Ä‚Äë–±–ª–æ–∫–æ–≤.  
5) `app/services/token_budget.py` ‚Äî –æ—Ü–µ–Ω–∫–∞ –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±—é–¥–∂–µ—Ç–∞.  
6) `app/utils/markdown.py` ‚Äî —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ.  
7) `app/utils/tg.py` ‚Äî –≤—Å–ø–ª—ã–≤–∞—à–∫–∏/TTL‚Äë—É–¥–∞–ª–µ–Ω–∏–µ/—Ä–µ–¥–∞–∫—Ç—ã.

---

## 5) Acceptance (—á—Ç–æ –ø–æ–∫–∞–∑–∞—Ç—å –Ω–∞ –¥–µ–º–æ)

1. Chat: OFF ‚Üí `‚ùì Ask` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ ¬´–í–∫–ª—é—á–∏ —á–∞—Ç‚Ä¶¬ª; –ø–æ—Å–ª–µ –∫–ª–∏–∫–∞ –æ–Ω–æ –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ ¬´–í–≤–µ–¥–∏ –≤–æ–ø—Ä–æ—Å‚Ä¶¬ª; –±–µ–∑ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.
2. Chat: ON ‚Üí ForceReply; –≤–≤–æ–∂—É –≤–æ–ø—Ä–æ—Å; –ø—Ä–æ–º–ø—Ç –∏ –º–æ–π –≤–æ–ø—Ä–æ—Å **—É–¥–∞–ª—èe—Ç—Å—è**; –ø–æ—è–≤–ª—è–µ—Ç—Å—è –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ ¬´–ì–æ—Ç–æ–≤–ª—é –æ—Ç–≤–µ—Ç‚Ä¶¬ª, –ø–æ—Ç–æ–º –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –æ—Ç–≤–µ—Ç.
3. –û—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç —á–∏–ø‚Äë—Å—Ç—Ä–æ–∫—É –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤; LLM –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª **—Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ** (active+linked) –∏ —É–ª–æ–∂–∏–ª—Å—è –≤ –±—é–¥–∂–µ—Ç.
4. –ü—Ä–∏ `Auto‚Äëclear: ON` ‚Äî –ø–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –æ—á–∏—â–µ–Ω—ã, –ø–∞–Ω–µ–ª—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç ¬´–ë—é–¥–∂–µ—Ç: ~0¬ª (–∏–ª–∏ –ø–æ –æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º).
5. –ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ –¥–ª–∏–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å/–º–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ ‚Üí graceful‚Äëdegrade (—É—Ä–µ–∑–∞–Ω –∫–æ–Ω—Ç–µ–∫—Å—Ç), –±–µ–∑ –ø–∞–¥–µ–Ω–∏–π.
6. –õ–æ–≥–∏: `model`, `tokens in/out`, `duration`, `project_ids`, `source_ids`, `user_id`. –ù–∏–∫–∞–∫–∏—Ö –≤—ã–∑–æ–≤–æ–≤ LLM –∏–∑ List/–ø–æ–∏—Å–∫–∞.

---

## 6) ¬´–ö—Ä–∞—Å–Ω—ã–µ –ª–∏–Ω–∏–∏¬ª –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏
- –ù–µ —Ç—Ä–æ–≥–∞—Ç—å —Å–ª—É–∂–µ–±–Ω—ã–µ —Ö–µ–Ω–¥–ª–µ—Ä—ã (List/–ø–æ–∏—Å–∫/–ø–∞–≥–∏–Ω–∞—Ü–∏—è) ‚Äî –æ–Ω–∏ **–±–µ–∑ LLM**.
- –í–µ—Å—å —Ç–µ–∫—Å—Ç –≤ Telegram –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ.
- –¢–æ–ª—å–∫–æ –æ–¥–∏–Ω ¬´–æ—Ç–≤–µ—Ç LLM¬ª –≤ —á–∞—Ç–µ (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, –∞ –Ω–µ –Ω–æ–≤—ã–π —Å–ø–∞–º).
- –õ—é–±–∞—è –æ—à–∏–±–∫–∞ ‚Äî human‚Äëfriendly, –±–µ–∑ —Ç—Ä–µ–π—Å–±–µ–∫–æ–≤ –≤ —á–∞—Ç.

‚Äî –ì–æ—Ç–æ–≤–æ. –í–∫–ª—é—á–∞–µ–º LLM –∏ –¥–µ—Ä–∂–∏–º –∞–Ω—Ç–∏—Ö—Ä—É–ø–∫–æ—Å—Ç—å.
